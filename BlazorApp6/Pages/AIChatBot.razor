@page "/ai-chat"
@implements IAsyncDisposable
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavigationManager
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject StudentManager StudentManager
@rendermode InteractiveServer

<div class="chat-page">

    <div class="sidebar p-3">
        <h5>AI Учител</h5>
        <p>Персонален помощник</p>
    </div>

    <div class="chat-container d-flex flex-column flex-grow-1">
        <div class="chat-window flex-grow-1 overflow-auto">

            @foreach (var m in messages)
            {
                if (m.SenderId == currentStudent.Id)
                {
                    <div class="my-message">
                        @((MarkupString)m.Content)
                        <sub><small>@m.Timestamp.ToString("HH:mm")</small></sub>
                    </div>
                }
                else
                {
                    <div class="other-message-sender">
                        <div class="other-message">
                            @((MarkupString)m.Content)
                            <sub><small>@m.Timestamp.ToString("HH:mm")</small></sub>
                        </div>
                    </div>
                }
            }

            <div class="input-bar d-flex align-items-center gap-2 mt-2">
                <InputFile OnChange="OnInputFileSelected" />
                <InputText @bind-Value="newMessage" class="form-control" placeholder="Напиши въпрос..." />
                <button class="btn-primary-send-message" @onclick="SendMessage">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private HubConnection? hubConnection;
    private Student currentStudent;
    private List<MessageForChat> messages = new();
    private string newMessage = "";

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var username = state.User.Identity?.Name;

        currentStudent = StudentManager.FindStudent(s => s.Username == username);
        if (currentStudent == null) return;

        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/aichat"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<Guid, Guid, string, string>("ReceiveMessage",
            (id, senderId, sender, content) =>
            {
                messages.Add(new MessageForChat(id, senderId, sender, content, DateTime.Now));
                InvokeAsync(StateHasChanged);
            });

        hubConnection.Reconnected += async _ =>
        {
            await hubConnection.SendAsync("JoinChat",
                new UserConnection(Guid.Empty,
                    new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)));
        };  

        await hubConnection.StartAsync();

        await hubConnection.SendAsync("JoinChat",
            new UserConnection(Guid.Empty,
                new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)));
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage) || hubConnection == null) return;

        await hubConnection.SendAsync("SendMessage",
            new UserConnection(Guid.Empty,
                new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)),
            new MessageToSend(Guid.NewGuid(), newMessage));

        newMessage = "";
    }

    private async Task OnInputFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null || hubConnection == null) return;

        using var stream = file.OpenReadStream(20 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);

        await hubConnection.SendAsync("SendFile",
            new UserConnection(Guid.Empty,
                new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)),
            file.Name,
            ms.ToArray());
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
            await hubConnection.DisposeAsync();
    }
}
