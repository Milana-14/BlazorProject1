@page "/register" // страница за регистрация на нов ученик
@layout GuestLayout
@rendermode InteractiveServer
@inject NavigationManager NavigationManager
@inject StudentManager StudentManager

<div class="login-page">
    <div class="login-card">
        <h3>Регистрация</h3>

        <EditForm Model="@registeredStudent" OnValidSubmit="Submit">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="register-form">
                <div class="name-row">
                    <InputText class="register-input" placeholder="Име" @bind-Value="registeredStudent.FirstName" />
                    <InputText class="register-input" placeholder="Фамилия" @bind-Value="registeredStudent.SecName" />
                </div>

                <InputNumber class="register-input" placeholder="Клас" @bind-Value="registeredStudent.Grade" />
                <InputText class="register-input" placeholder="Имейл" @bind-Value="registeredStudent.Email" />
                <InputText class="register-input" placeholder="Юзърнейм" @bind-Value="registeredStudent.Username" />
                <InputText type="password" class="register-input" placeholder="Парола" @bind-Value="registeredStudent.Password" />
            </div>


            <button type="submit" class="btn-login">Регистрирай се</button>
        </EditForm>

        @if (registeredSuccessfully)
        {
            <div class="alert alert-success">
                Добре дошъл, @registeredStudent.FirstName!
            </div>
        }

        @if (userNameAlreadyExists)
        {
            <div class="alert alert-danger">
                Ученик с това потребителско име вече съществува.
            </div>
        }
        else if (userNameAlreadyExists)
        {
            <div class="alert alert-danger">
                Ученик с този имейл вече съществува.
            </div>
        }

        @if (!string.IsNullOrEmpty(StudentManager.DbError))
        {
            <div class="alert alert-danger">
                Грешка при зареждането на данните: @StudentManager.DbError
            </div>
        }

        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger">@errorMessage</div>
        }
    </div>
</div>

@code {
    private Student? registeredStudent = new Student();

    private bool userNameAlreadyExists = false;
    private bool emailAlreadyExists = false;
    private string errorMessage = string.Empty;
    private bool registeredSuccessfully = false;

    private void Submit()
    {
        try
        {
            if (StudentManager.FindStudent(s => s.Username == registeredStudent.Username) != null)
            {
                registeredSuccessfully = false;
                userNameAlreadyExists = true;
                registeredStudent = new Student();
                return;
            }

            if (StudentManager.FindStudent(s => s.Email == registeredStudent.Email) != null)
            {
                registeredSuccessfully = false;
                emailAlreadyExists = true;
                registeredStudent = new Student();
                return;
            }

            string hashedPassword = HashPasswordService.HashPassword(registeredStudent.Password);

            Student newStudent = new Student(
                registeredStudent.FirstName,
                registeredStudent.SecName,
                registeredStudent.Email,
                registeredStudent.Username,
                hashedPassword,
                registeredStudent.Grade
            );

            StudentManager.AddStudent(newStudent);
            registeredSuccessfully = true;
            errorMessage = string.Empty;
            userNameAlreadyExists = false;
            emailAlreadyExists = false;

            NavigationManager.NavigateTo("/login");
        }
        catch (ApplicationException ex)
        {
            errorMessage = ex.Message;
            registeredStudent = null;
        }
    }
}  