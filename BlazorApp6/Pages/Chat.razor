@page "/chat/{SwapId:guid}"
@implements IAsyncDisposable
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.SignalR.Client
@using SwapModel = BlazorApp6.Models.Swap
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager NavigationManager
@inject IHttpContextAccessor HttpContextAccessor
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject StudentManager StudentManager
@inject AvatarManager AvatarManager
@inject SwapManager SwapManager
@inject ChatManager ChatManager
@inject RateHelpManager RateHelpManager
@inject OnlineUsersService OnlineUsers
@inject IJSRuntime JS
@rendermode InteractiveServer

<div class="main-chat-page" @onclick="HideContextMenu">

    <div class="chat-topbar">
        <div class="chat-topbar-left @(isSidebarHidden ? "no-info" : "with-info")">
            <img src="@AvatarManager.GetAvatarUrl(otherStudent.AvatarName)" class="chat-topbar-avatar" />
            <div class="chat-topbar-user">
                <div class="chat-topbar-name">@otherStudent.FirstName @otherStudent.SecName</div>
                <div class="chat-topbar-sub">
                    <span class="chat-status @(OnlineUsers.IsOnline(otherStudent.Id) ? "online" : "offline")">
                        @(OnlineUsers.IsOnline(otherStudent.Id) ? "Онлайн" : "Оффлайн")
                    </span>
                    <span class="dot">•</span>
                    <span class="chat-subject">@swap.SubjectForHelp.GetDisplayName()</span>
                </div>
            </div>
        </div>

        <div class="chat-topbar-right @(isSidebarHidden ? "no-info" : "with-info")">
            <span class="swap-status status-@swap.Status.ToString().ToLower()">@swapStatusName</span>
        </div>
    </div>

    <div class="chat-page @(isSidebarHidden ? "no-info" : "with-info")">
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <p class="text-danger">@errorMessage</p>
        }
        else
        {
            <div class="chat-info-sidebar @(isSidebarHidden ? "hidden" : "")">
                <button class="close-sidebar-btn" @onclick="ToggleSidebar"><i class="bi bi-x-lg"></i></button>
                <div class="chat-info-profile">
                    <img src="@AvatarManager.GetAvatarUrl(otherStudent.AvatarName)" alt="Avatar" class="chat-info-profile-avatar" />
                    <h4>@otherStudent.FirstName @otherStudent.SecName</h4>
                    <span class="user-status">@((OnlineUsers.IsOnline(otherStudent.Id)) ? "Онлайн" : "Оффлайн")</span>
                </div>
                <div class="chat-info-actions">
                    <div class="chat-info-action"><i class="bi bi-person"></i><span @onclick="() => ViewProfile(otherStudent)">Виж профила</span></div>
                    @if (swap.Status == SwapStatus.Confirmed)
                    {
                        <div class="chat-info-action"><i class="bi bi-person"></i><span @onclick="ProposeCompletion">Предложи завършване</span></div>
                    }
                    <div class="chat-info-action" @onclick="() => ReportPartner(otherStudent)"><i class="bi bi-x-circle"></i><span>Репортни</span></div>
                </div>
                <div class="chat-info-section">
                    @(currentStudent.Id == swap.Student2Id ? "Помагаш по" : $"{otherStudent.FirstName} ти помага по"): @swap.SubjectForHelp.GetDisplayName().ToLower()
                    <br />
                    Активен от: @swap.DateConfirmed
                    <br />
                    Статус на свапа: @swapStatusName
                </div>
            </div>

            @if (swap.Status == SwapStatus.Confirmed || swap.Status == SwapStatus.PendingCompleted || swap.Status == SwapStatus.CompletedNotRated)
            {
                <div class="chat-container d-flex flex-column flex-grow-1">
                    <div class="chat-window flex-grow-1 overflow-auto" @ref="chatWindowRef">
                        @code {
                            DateTime? lastDate = null;
                            MessageForChat? previousMessage = null;
                        }

                        @foreach (var m in messagesForChat)
                        {
                            bool showAvatar = previousMessage == null || previousMessage.SenderId != m.SenderId || previousMessage.Timestamp.Date != m.Timestamp.Date;
                            DateTime date = m.Timestamp.Date;
                                    
                            if (lastDate == null || lastDate.Value != date)
                            {
                                <div class="chat-date-separator">@date.ToString("dd MMMM yyyy")</div>
                                lastDate = date;
                            }

                            if (m.SenderName == $"{currentStudent.FirstName} {currentStudent.SecName}")
                            {
                                <div class="my-message" @oncontextmenu:preventDefault="true" @oncontextmenu="@(e => ShowContextMenu(e, m))">
                                    @if (m.ReplyToMessageId != null)
                                    {
                                        var replied = messagesForChat.FirstOrDefault(x => x.Id == m.ReplyToMessageId);
                                        if (replied != null)
                                        {
                                            <div class="reply-inline">
                                                <small>
                                                    Отговор на себе си: @replied.Content
                                               </small>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="reply-inline deleted">
                                                <small>Съобщението е изтрито</small>
                                            </div>
                                        }
                                    }
                                    @((MarkupString)m.Content)
                                    <sub><small><time>@(m.IsEdited ? $"редактирано {m.Timestamp:HH:mm}" : m.Timestamp.ToLocalTime().ToString("HH:mm"))</time></small></sub>
                                </div>
                            }
                            else if (m.SenderName == $"{otherStudent.FirstName} {otherStudent.SecName}")
                            {
                                <div class="other-message-sender" @oncontextmenu:preventDefault="true" @oncontextmenu="@(e => ShowContextMenu(e, m))">
                                    @if (showAvatar)
                                    {
                                        <img src="@AvatarManager.GetAvatarUrl(otherStudent.AvatarName)" class="chat-avatar" />
                                    }
                                    else
                                    {
                                        <div class="chat-avatar-placeholder"></div>
                                    }
                                    @if (m.ReplyToMessageId != null)
                                    {
                                        var replied = messagesForChat.FirstOrDefault(x => x.Id == m.ReplyToMessageId);
                                        if (replied != null)
                                        {
                                            <div class="reply-inline">
                                                <small>
                                                    Отговор на <b>@replied.SenderName</b>: @replied.Content
                                               </small>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="reply-inline deleted">
                                                <small>Съобщението е изтрито</small>
                                            </div>
                                        }
                                    }
                                    <div class="other-message">
                                        @((MarkupString)m.Content)
                                        <sub><small><time>@(m.IsEdited ? $"редактирано {m.Timestamp:HH:mm}" : m.Timestamp.ToLocalTime().ToString("HH:mm"))</time></small></sub>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="system-message"><i>@m.Content</i><small><time>@m.Timestamp.ToLocalTime():HH:mm</time></small></div>
                            }

                            previousMessage = m;
                        }
                    </div>
                </div>

                @if (replyToMessage != null)
                {       
                    <div class="reply-preview">
                        <div class="reply-preview-header">
                            <span>
                                Отговор на <strong>@replyToMessage.SenderName</strong>
                            </span>
                            <button @onclick="CancelReply"><i class="bi bi-x-lg"></i></button>
                        </div>

                       <div class="reply-preview-content">
                            @replyToMessage.Content
                        </div>
                    </div>
                }


                    <div class="chat-bottom-fixed input-bar-wrapper">
                         @if (swap.Status == SwapStatus.PendingCompleted && swap.CompletionProposedByStudentId.HasValue)
                        {
                            <div class="chat-system-card swap-card">
                                @if (swap.CompletionProposedByStudentId.Value != currentStudent.Id)
                                {
                                    <div class="swap-card-title"> @otherStudent.FirstName предложи да завършите свапа</div>
                                        
                                    <div class="swap-card-actions">
                                        <button class="btn-danger" @onclick="AcceptCompletion">Завърши</button>
                                        <button class="btn-secondary1" @onclick="RejectCompletion">Продължи</button>
                                    </div>
                                }
                                else
                                {
                                    <div class="swap-card-title"> Вие предложихте да завършите свапа</div>
                                    <div class="swap-card-sub">Очаквайте потвърждение от @otherStudent.FirstName</div>
                                        
                                    <div class="swap-card-actions">
                                        <button class="btn-secondary" @onclick="CancelProposeCompletion">Отмяна</button>
                                    </div>
                                }
                            </div>

                        }
                        @if (swap.Status == SwapStatus.CompletedNotRated && !isStudentToRate)
                        {
                            <div class="chat-system-card rate-card">
                                    <div class="rate-card-title">
                                        Оцени помощта на @otherStudent.FirstName
                                    </div>

                                    <div class="rate-stars">
                                        <span class="rate-star @(1 <= selectedRating ? "selected" : "")" @onclick="() => selectedRating = 1">&#9733;</span>
                                        <span class="rate-star @(2 <= selectedRating ? "selected" : "")" @onclick="() => selectedRating = 2">&#9733;</span>
                                        <span class="rate-star @(3 <= selectedRating ? "selected" : "")" @onclick="() => selectedRating = 3">&#9733;</span>
                                        <span class="rate-star @(4 <= selectedRating ? "selected" : "")" @onclick="() => selectedRating = 4">&#9733;</span>
                                        <span class="rate-star @(5 <= selectedRating ? "selected" : "")" @onclick="() => selectedRating = 5">&#9733;</span>
                                    </div>

                                    <textarea class="rate-textarea" placeholder="Добави коментар" @bind="ratingComment"></textarea>

                                    <button class="rate-send-btn" @onclick="RateStudentsHelp" disabled="@(selectedRating == null || string.IsNullOrEmpty(ratingComment))">
                                        Изпрати
                                    </button>
                                </div>
                        }
                        else if (swap.Status == SwapStatus.CompletedNotRated && isStudentToRate)
                        {
                            <div class="chat-system-card rate-card">
                                <p><strong>Благодарим ти</strong>, че помогна на @otherStudent.FirstName по @swap.SubjectForHelp.GetDisplayName().ToLower().</p>
                                <p class="sub">@otherStudent.FirstName ще оцени помощта ти.</p>
                            </div>
                        }

                        @* Редактиране *@
                        @if (IsEditing)
                        {       
                            <div class="edit-preview">
                                <div class="edit-preview-header">
                                    <span>Редактиране</span>
                                    <button @onclick="CancelEdit"><i class="bi bi-x-lg"></i></button>
                                </div>
                            </div>
                        }

                        <div class="input-bar @(isSidebarHidden ? "no-info" : "with-info") d-flex align-items-center">
                            <button class="btn-emoji" @onclick="ToggleEmojiPanel">😀</button>
                            <label for="fileInput" class="btn-file"><i class="bi bi-paperclip"></i></label>
                            <InputFile id="fileInput" OnChange="OnInputFileSelected" style="display:none;" />
                            <InputText @bind-Value="CurrentInputText" placeholder="Напиши съобщение..." @onkeydown="HandleSendKeydown" />
                            <button class="btn-@(IsEditing ? "check" : "send")"
                                    disabled="@(IsEditing ? string.IsNullOrWhiteSpace(editingText) : string.IsNullOrWhiteSpace(newMessage))"
                                    @onclick="@(IsEditing? SaveEditedMessage : SendMessage)">
                                <i class="bi bi-@(IsEditing ? "check-lg" : "send")"></i>
                            </button>
                        </div>
                    </div>
                    
            }

                @if (contextMenuVisible)
                {
                    <div class="context-menu" style="top:@contextMenuYpx; left:@contextMenuXpx; position:absolute; z-index:1000;">
                        <button class="ctx-btn"><i class="bi bi-reply-fill"></i> Отговори</button>
                        @if (selectedMessage != null && selectedMessage.SenderId == currentStudent.Id)
                        {
                            <button class="ctx-btn"><i class="bi bi-pencil-fill"></i> Редактирай</button>
                            <button class="ctx-btn"><i class="bi bi-trash-fill"></i> Изтрий съобщение</button>
                        }
                    </div>
                }
        }
    </div>
</div>

@if (isSidebarHidden)
{
    <button class="open-sidebar-btn" @onclick="ToggleSidebar">
        <i class="bi bi-info-circle-fill"></i>
    </button>
}


@code {
    [Parameter] public Guid swapId { get; set; }
    private SwapModel? swap;
    private Student? currentStudent;
    private Student? otherStudent;
    private HubConnection? hubConnection;

    private List<Message> messages = new();
    private List<MessageForChat> messagesForChat = new();
    private string newMessage = string.Empty;

    private bool contextMenuVisible = false;
    private string contextMenuXpx, contextMenuYpx;
    private MessageForChat? selectedMessage;
    private MessageForChat? replyToMessage;

    private string swapStatusName => swap.Status switch
    {
        SwapStatus.Pending => "Очаква потвърждение",
        SwapStatus.Confirmed => "Активен",
        SwapStatus.PendingCompleted => "Предложено завършване",
        SwapStatus.CompletedNotRated => "Завършен - чака оценка",
        SwapStatus.Completed => "Завършен",
        _ => "Неизвестен статус"
    };

    private string CurrentInputText
    {
        get => IsEditing ? editingText : newMessage;
        set
        {
            if (IsEditing)
                editingText = value;
            else
                newMessage = value;
        }
    }

    private bool isStudentToRate;
    private int? selectedRating { get; set; }
    private string ratingComment = "";

    private string? errorMessage;

    private MessageForChat? editingMessage = null;
    private string editingText = string.Empty;
    private bool IsEditing => editingMessage != null;

    private ElementReference chatWindowRef;
    private bool isSidebarHidden = false;

    protected override async Task OnParametersSetAsync()
    {
        swap = SwapManager.FindSwapById(swapId);
        if (swap == null) { errorMessage = "Свапът не е намерен."; return; }

        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        if (!user.Identity.IsAuthenticated)
        {
            currentStudent = null;
            return;
        }

        var username = user.Identity.Name;

        currentStudent = StudentManager.FindStudent(s => s.Username == username);

        isStudentToRate = swap.Student2Id == currentStudent.Id;

        if (currentStudent == null)
        {
            errorMessage = "Профилът не е намерен.";
            return;
        }

        otherStudent = swap.Student1Id == currentStudent.Id
            ? StudentManager.FindStudent(s => s.Id == swap.Student2Id)
            : StudentManager.FindStudent(s => s.Id == swap.Student1Id);
        if (otherStudent == null) { errorMessage = "Другият ученик не е намерен."; return; }

        messages = ChatManager.GetMessagesFromDb(swapId);
        messagesForChat = messages.Select(m => new MessageForChat(
        m.Id,
        m.SenderId,
        m.SenderId == currentStudent.Id
            ? $"{currentStudent.FirstName} {currentStudent.SecName}"
            : $"{otherStudent.FirstName} {otherStudent.SecName}",
        m.Content,
        m.Timestamp,
        m.IsRead,
        m.IsEdited, 
        m.ReplyToMessageId)).ToList();


        if (hubConnection != null) return;

        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/chathub"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<string>("UserJoined", (username) =>
        {
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<Guid, Guid, string, string, DateTime, Guid?>("ReceiveMessage", async (messageid, senderId, username, message, time, replyToMessageId) =>
        {
            messagesForChat.Add(new MessageForChat(messageid, senderId, username, message, time, senderId == currentStudent.Id, false, replyToMessageId));
            await InvokeAsync(StateHasChanged);
            await ScrollToBottomAsync();
        });

        try
        {
            await hubConnection.StartAsync();
            await hubConnection.SendAsync("JoinChat",
                new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)));
        }
        catch (Exception ex)
        {
            errorMessage = "Не успяхме да се свържем с чата: " + ex.Message;
        }

        if (hubConnection != null)
        {
            await hubConnection.SendAsync("MarkAsRead",
                new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)));
        }


        hubConnection.On<Guid>("DeleteMessage", (messageId) =>
        {
            var msg = messagesForChat.FirstOrDefault(m => m.Id == messageId);
            if (msg != null)
            {
                messagesForChat.Remove(msg);
                InvokeAsync(StateHasChanged);
            }
        });

        hubConnection.On<Guid, string>("EditMessage", (messageId, newContent) =>
        {
            var msg = messagesForChat.FirstOrDefault(m => m.Id == messageId);
            if (msg != null)
            {
                msg.Content = newContent;
                msg.IsEdited = true;
                InvokeAsync(StateHasChanged);
            }
        });


        hubConnection.On<Guid>("NewUnread", async swapId =>
        {
            messages = ChatManager.GetMessagesFromDb(swapId);
            messagesForChat = messages.Select(m => new MessageForChat(
                m.Id,
                m.SenderId,
                m.SenderId == currentStudent.Id
                    ? $"{currentStudent.FirstName} {currentStudent.SecName}"
                    : $"{otherStudent.FirstName} {otherStudent.SecName}",
                m.Content,
                m.Timestamp,
                m.IsRead,
                m.IsEdited,
                m.ReplyToMessageId)).ToList();

            await InvokeAsync(StateHasChanged);
        });

        hubConnection.On<SwapModel>("SwapUpdated", updatedSwap =>
        {
            swap = updatedSwap;
            isStudentToRate = currentStudent.Id == swap.Student2Id;
            InvokeAsync(StateHasChanged);
        });


        ChatManager.MarkMessagesAsRead(swapId, currentStudent.Id);
    }

    private bool _firstRender = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            _firstRender = false;
            if (messagesForChat.Any())
            {
                await ScrollToBottomAsync();
            }
        }
    }


    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage) || hubConnection == null) return;

        var message = new MessageToSend(Guid.NewGuid(), newMessage, DateTime.UtcNow, replyToMessage?.Id);

        await hubConnection.SendAsync("SendMessage",
            new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)),
            message);

        newMessage = string.Empty;
        replyToMessage = null;
    }

    private void ToggleEmojiPanel() { /* вставка эмодзи */ }

    private async Task OnInputFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        using var stream = file.OpenReadStream(10 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        byte[] fileBytes = ms.ToArray();

        await hubConnection.SendAsync("SendFile",
            new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)),
            file.Name,
            fileBytes);
    }

    private async Task DeleteMessage()
    {
        if (hubConnection == null) return;
        if (selectedMessage == null) return;
        if (currentStudent?.Id != selectedMessage.SenderId) return;

        await hubConnection.SendAsync("DeleteMessage",
                new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)),
                selectedMessage.Id);

        contextMenuVisible = false;
        selectedMessage = null;
    }

    private void EditMessage()
    {
        if (selectedMessage == null || currentStudent?.Id != selectedMessage.SenderId) return;

        editingMessage = selectedMessage;
        editingText = selectedMessage.Content;
        contextMenuVisible = false;
        selectedMessage = null;
    }

    private async Task SaveEditedMessage()
    {
        if (editingMessage == null || hubConnection == null || string.IsNullOrWhiteSpace(editingText)) return;

        await hubConnection.SendAsync("EditMessage",
            new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)),
            editingMessage.Id,
            editingText);

        editingMessage = null;
        editingText = string.Empty;
    }

    private void CancelEdit()
    {
        editingMessage = null;
        editingText = string.Empty;
    }

    private async Task HandleSendKeydown(KeyboardEventArgs e)
    {
        if (e.Key != "Enter") return;

        if (!IsEditing)
        {
            if (!string.IsNullOrWhiteSpace(newMessage))
            {
                await SendMessage();
            }
        }
    }

    private void ReplyToMessage()
    {
        if (selectedMessage == null) return;

        replyToMessage = selectedMessage;

        contextMenuVisible = false;
        selectedMessage = null;
    }

    private void CancelReply()
    {
        replyToMessage = null;
    }


    private void ShowContextMenu(MouseEventArgs e, MessageForChat message)
    {
        selectedMessage = message;
        contextMenuXpx = $"{e.ClientX}px";
        contextMenuYpx = $"{e.ClientY}px";
        contextMenuVisible = true;
    }

    private void HideContextMenu()
    {
        contextMenuVisible = false;
        selectedMessage = null;
    }


    private async Task ScrollToBottomAsync()
    {
        await JS.InvokeVoidAsync("blazorScrollToBottom", chatWindowRef);
    }


    private async Task ProposeCompletion()
    {
        await hubConnection.SendAsync("ProposeCompletion", swap.Id, currentStudent.Id);
    }

    private async Task CancelProposeCompletion()
    {
        await hubConnection.SendAsync("RejectCompletion", swap.Id, currentStudent.Id);
    }

    private async Task AcceptCompletion()
    {
        await hubConnection.SendAsync("AcceptCompletion", swap.Id, currentStudent.Id);
    }

    private async Task RejectCompletion()
    {
        await hubConnection.SendAsync("RejectCompletion", swap.Id, currentStudent.Id);
    }


    private void ChooseRating(int rating) => selectedRating = rating;

    private async Task RateStudentsHelp()
    {
        if (selectedRating == null) return;
        if (ratingComment == null) return;

        RateHelpManager.RateSwap(swap, ratingComment, selectedRating.Value);

        if (isStudentToRate)
        {
            currentStudent.HelpGivenCount++;
            currentStudent.Coins++;
            StudentManager.UpdateStudent(currentStudent);

            otherStudent.Coins--;
            StudentManager.UpdateStudent(otherStudent);
        }
        else
        {
            otherStudent.HelpGivenCount++;
            otherStudent.Coins++;
            StudentManager.UpdateStudent(otherStudent);

            currentStudent.Coins--;
            StudentManager.UpdateStudent(currentStudent);
        }

        SwapManager.CompleteSwap(swap);
        await hubConnection.SendAsync("AcceptCompletion", swap.Id, currentStudent.Id);

        NavigationManager.NavigateTo("/my-swaps");
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null && currentStudent != null)
        {
            await hubConnection.SendAsync("LeaveChat",
                new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)));
            await hubConnection.DisposeAsync();
        }
    }

    private void ToggleSidebar()
    {
        isSidebarHidden = !isSidebarHidden;
    }

    private void ViewProfile(Student student)
    {
        NavigationManager.NavigateTo($"/other-profile/{student.Id}");
    }

    private async Task ReportPartner(Student studentToReport) { /* TODO */ }
}