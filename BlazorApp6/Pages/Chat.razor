@page "/chat/{SwapId:guid}" // страница за чат
@implements IAsyncDisposable
@inject NavigationManager NavigationManager
@inject AppState AppState
@inject StudentManager StudentManager
@inject AvatarManager AvatarManager
@inject SwapManager SwapManager
@inject ChatManager ChatManager
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@using SwapModel = BlazorApp6.Models.Swap

@if (!string.IsNullOrEmpty(errorMessage))
{
    <p class="text-danger">@errorMessage</p>
}
else
{
<div class="chat-page d-flex">

    <div class="sidebar p-3">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5>@otherStudent.FirstName @otherStudent.SecName</h5>
            <button class="btn btn-sm btn-danger" @onclick="ReportPartner">Репортни</button>
        </div>
        <p><strong>Предмет:</strong> @swap.SubjectForHelp</p>
        <p><strong>Статус на свапа:</strong> @swap.Status</p>

            @if (swap.Status == SwapStatus.PendingCompleted)
            {
                if (swap.CompletionProposedByStudentId.HasValue && swap.CompletionProposedByStudentId.Value != currentStudent.Id)
                {
                    <div class="alert alert-warning p-2">
                        <p>@otherStudent.FirstName иска да завърши свапа</p>
                        <button class="btn btn-sm btn-success ms-2" @onclick="AcceptCompletion">Завърши</button>
                        <button class="btn btn-sm btn-secondary ms-1" @onclick="RejectCompletion">Продължи свапа</button>
                    </div>
                }
                else
                {
                    <div class="alert alert-info p-2">
                        <p>Вие предложихте да завършите свапа. Очаква се потвърждението на @otherStudent.FirstName.</p>
                    </div>
                }
            }
            else if (swap.Status == SwapStatus.CompletedNotRated)
            {
                if (isStudentToRate)
                {
                    <p>Очаква се @otherStudent.FirstName да оцени Вашата помощ.</p>
                }
                else
                {
                    <p>Моля, оставете отзив за помощта на @otherStudent.FirstName @otherStudent.SecName.</p>
                }
            }
            else
            {
                <button class="btn btn-sm btn-primary" @onclick="ProposeCompletion">Предложи завършване</button>
            }
    </div>


        @if (swap.Status == SwapStatus.Confirmed || swap.Status == SwapStatus.PendingCompleted)
    {
    <div class="chat-container d-flex flex-column flex-grow-1">
        <div class="chat-window flex-grow-1 overflow-auto">
            @code { DateTime? lastDate = null; }
            @foreach (var m in messagesForChat)
                        {
                        DateTime date = m.Timestamp.Date;
                        if (lastDate == null || lastDate.Value != date)
                        {
            <div class="chat-date-separator">
                @date.ToString("dd MMMM yyyy")
            </div>
                        lastDate = date;
                        }

            @if (m.SenderName == $"{currentStudent.FirstName} {currentStudent.SecName}")
            {
                <div class="my-message-sender">
                    <small>@m.SenderName:</small>
                </div>
                <div class="my-message">
                    @m.Content
                    <sub><small><time>@m.Timestamp.ToString("HH:mm")</time></small></sub>
                </div>
            }
            else if (m.SenderName == $"{otherStudent.FirstName} {otherStudent.SecName}")
            {
                <div class="other-message-sender">
                    <img src="@AvatarManager.GetAvatarUrl(otherStudent.AvatarName)" class="avatar me-2" />
                    <small>@m.SenderName:</small>
                </div>
                <div class="other-message">
                    @m.Content
                    <sub><small><time>@m.Timestamp.ToString("HH:mm")</time></small></sub>
                </div>
            }
            else
            {
                <div class="system-message">
                    @if (string.IsNullOrEmpty(m.SenderName))
                    {
                        <i>@m.Content</i>
                        <small><time>@m.Timestamp.ToString("HH:mm")</time></small>
                    }
                    else
                    {
                        <i>@m.SenderName: @m.Content</i>
                        <small><time>@m.Timestamp.ToString("HH:mm")</time></small>
                    }
                </div>
            }
                        }

            <div class="input-container mt-2 d-flex gap-2">
                <input class="form-control" @bind="newMessage" placeholder="Напиши..." />
                <button class="btn btn-primary" @onclick="SendMessage">Изпрати</button>
            </div>
        </div>
    </div>
    }
    else if (swap.Status == SwapStatus.CompletedNotRated)
    {
        if (isStudentToRate)
        {
            <p>Очаква се @otherStudent.FirstName да оцени Вашата помощ.</p>
        }
        else
        {
            <div class="stars-container mb-3">
                @for (int i = 1; i <= 5; i++)
                {
                    <span class="star @(SelectedRating >= i ? "selected" : "")" @onclick="() => ChooseRating(i)">&#9733;</span>
                }
            </div>


            <div class="modal-actions mt-3 d-flex gap-2">
                <button class="btn btn-primary" disabled="@(!isChosen)" @onclick="RateStudentsHelp">Изпрати</button>
            </div>
        }
    }
    else if (swap.Status == SwapStatus.Completed)
    {
        <p>Този свап е завършен.</p>
    }
</div>
}

@code {
    [Parameter] public Guid swapId { get; set; }
    private SwapModel? swap;

    private Student? currentStudent;
    private Student? otherStudent;

    private HubConnection? hubConnection;
    private List<Message> messages = new();
    private List<MessageForChat> messagesForChat = new();
    private string newMessage = string.Empty;

    private bool isStudentToRate;

    private string? errorMessage = string.Empty;

    private Student? StudentToRate;
    private List<int> stars = new() { 1, 2, 3, 4, 5 };
    private int? SelectedRating { get; set; } = null;
    private bool isChosen => SelectedRating != null;


    protected override async Task OnParametersSetAsync()
    {
        swap = SwapManager.FindSwapById(swapId);
        if (swap == null)
        {
            errorMessage = "Свапът не е намерен.";
        }
        currentStudent = AppState.CurrentUser;
        if (currentStudent == null)
        {
            errorMessage = "Моля, влезте в профила си.";
            return;
        }
        otherStudent = (swap.Student1Id == currentStudent.Id) ? StudentManager.FindStudent(s => s.Id == swap.Student2Id) : StudentManager.FindStudent(s => s.Id == swap.Student1Id);
        if (otherStudent == null)
        {
            errorMessage = "Другият ученик не е намерен.";
            return;
        }

        messages = ChatManager.GetMessagesFromDb(swapId);
        messagesForChat = messages.Select(m => new MessageForChat(
            m.SenderId == currentStudent.Id 
            ? $"{currentStudent.FirstName} {currentStudent.SecName}" 
            : $"{otherStudent.FirstName} {otherStudent.SecName}"
            , m.Content)).ToList();


        if (hubConnection != null) return;

        hubConnection = new HubConnectionBuilder().WithUrl(NavigationManager.ToAbsoluteUri("/chathub")).WithAutomaticReconnect().Build();

        hubConnection.Reconnected += async (id) =>
        {
            await hubConnection.SendAsync("JoinChat", new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)));
        };

        hubConnection.On<string>("UserJoined", (username) =>
        {
            messages.Add(new Message(swapId, Guid.Empty, $"{username} влезе в чата"));
            messagesForChat.Add(new MessageForChat(string.Empty, $"{username} влезе в чата"));
            InvokeAsync(StateHasChanged);
        });
        hubConnection.On<Guid, string, string>("ReceiveMessage", (studentId, username, message) =>
        {
            messages.Add(new Message(swapId, studentId, message));
            messagesForChat.Add(new MessageForChat(username, message));
            InvokeAsync(StateHasChanged);
        });

        try
        {
            await hubConnection.StartAsync();
            await hubConnection.SendAsync("JoinChat", new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)));
        }
        catch (Exception ex)
        {
            errorMessage = "Не успяхме да се свържем с чата: " + ex.Message;
        }
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrEmpty(newMessage) && hubConnection != null)
        {
            await hubConnection.SendAsync("SendMessage", new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)), newMessage);
            newMessage = string.Empty;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null && currentStudent != null)
        {
            await hubConnection.SendAsync("LeaveChat", new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)));
            await hubConnection.DisposeAsync();
        }
    }

    private void ProposeCompletion()
    {
        SwapManager.ProposeCompletingSwap(swap, currentStudent.Id);
        StateHasChanged();
    }
    private void AcceptCompletion()
    {
        swap.Status = SwapStatus.CompletedNotRated;
        SwapManager.UpdateSwapInDb(swap);
        if (currentStudent.Id.ToString() == swap.Student2Id.ToString()) isStudentToRate = true;
        else if (currentStudent.Id.ToString() == swap.Student1Id.ToString()) isStudentToRate = false;
    }
    private void RejectCompletion()
    {
        SwapManager.RejectCompletion(swap);
        StateHasChanged();
    }

    private void ChooseRating(int rating)
    {
        SelectedRating = rating;
    }

    private async Task RateStudentsHelp()
    {
        if (SelectedRating == null) return;

        otherStudent.HelpGivenCount += 1;
        otherStudent.HelpRatings.Add(SelectedRating.Value);
        otherStudent.Coins += 1;
        StudentManager.UpdateStudent(otherStudent);

        currentStudent.Coins -= 1;
        StudentManager.UpdateStudent(currentStudent);

        SwapManager.CompleteSwap(swap);

        NavigationManager.NavigateTo("/my-swaps");
    }

    private async Task ReportPartner()
    {
        // логика за репортване на другия ученик
        // SwapManager.ReportStudent(otherStudent.Id, swapId);
    }
}

<style>
    .chat-page {
        display: flex;
        height: 90vh;
        gap: 15px;
    }

    .sidebar {
        width: 300px;
        flex-shrink: 0;
        border-right: 1px solid #ccc;
        overflow-y: auto;
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
    }

    .chat-window {
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #f8f9fa;
        flex-grow: 1;
    }


    .chat-date-separator {
        text-align: center;
        font-size: 0.9rem;
        color: gray;
        margin: 10px 0;
    }

    .my-message {
        align-self: flex-end;
        background: #007bff;
        color: white;
        padding: 6px 10px;
        border-radius: 10px 10px 0 10px;
        max-width: 60%;
    }
    .my-message-sender {
        align-self: flex-end;
        color: gray;
        font-size: 0.85rem;
    }

    .other-message {
        align-self: flex-start;
        background: #e5e5ea;
        color: black;
        padding: 6px 10px;
        border-radius: 10px 10px 10px 0;
        max-width: 60%;
    }
    .other-message-sender {
        align-self: flex-start;
        color: gray;
        font-size: 0.85rem;
        }

    .system-message {
        align-self: center;
        color: gray;
        font-style: italic;
        font-size: 0.85rem;
    }

    .avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
    }

    .stars-container {
        display: flex;
        flex-direction: row-reverse;
        justify-content: center;
        gap: 5px;
        font-size: 32px;
        cursor: pointer;
    }

    .star {
        color: #ccc;
        transition: color 0.2s;
    }

        .star.selected,
        .star:hover,
        .star:hover ~ .star {
            color: #ffc107;
        }

    .modal-actions button {
        min-width: 100px;
    }
</style>