@page "/students-filter" // страница за филтриране на ученици
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Forms
@inject IHttpContextAccessor HttpContextAccessor
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject StudentManager StudentManager
@inject AvatarManager AvatarManager
@inject SwapManager SwapManager
@inject RateHelpManager RateHelpManager
@inject IHubContext<SwapHub> swapHubContext
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR
@using SwapModel = BlazorApp6.Models.Swap

<div class="main-page">

@if (currentStudent == null)
{
    <p>Моля, влезте в профила си</p>
}
else
{
    @* Филтри *@
    <div class="filter-header-container">
    <div class="filter-header">
        <h2 class="filter-title">Намери ученици за взаимопомощ</h2>
    </div>

    @* Клас *@
    <div class="filter-all-container">

    <fieldset class="filter-section-grade1">
        <p class="filter-legend">Клас:</p>
        <div class="checkbox-group1">
            @foreach (var grade in allGrades.OrderBy(g => g))
            {
                    <label class="checkbox-item">
                        <input type="checkbox"
                               checked="@selectedGrades.Contains(grade)"
                               @onchange="async (ChangeEventArgs e) => await ToggleGrade(grade, ValueToBool(e.Value))"
                               class="hidden-checkbox" />
                        <span class="circle @(selectedGrades.Contains(grade) ? "circle-active" : "circle-nonactive")">
                            @grade
                        </span>
                    </label>
            }
        </div>
    </fieldset>

        @* Предмети *@
        <div class="filter-subject-container">
            <fieldset class="filter-section1">
                <p class="filter-legend">Може да помогне с:</p>
                <div class="checkbox-group2">
                    @foreach (var subject in allSubjects)
                    {
                        <label class="checkbox-item">
                            <input type="checkbox"
                                   checked="@selectedCanHelpWith.Contains(subject)"
                                   @onchange="async (ChangeEventArgs e) => await ToggleSubject(subject, ValueToBool(e.Value), selectedCanHelpWith)"
                                   class="hidden-checkbox" />
                            <span class="badge @(selectedCanHelpWith.Contains(subject) ? "badge-filter-active" : "badge-filter-nonactive")">
                                @subject.GetDisplayName()
                            </span>
                        </label>
                    }
                </div>
            </fieldset>

            <fieldset class="filter-section1">
                <p class="filter-legend">Търси помощ по:</p>
                <div class="checkbox-group2">
                    @foreach (var subject in allSubjects)
                    {
                        <label class="checkbox-item">
                            <input type="checkbox"
                                   checked="@selectedNeedsHelpWith.Contains(subject)"
                                   @onchange="async (ChangeEventArgs e) => await ToggleSubject(subject, ValueToBool(e.Value), selectedNeedsHelpWith)"
                                   class="hidden-checkbox" />
                            <span class="badge @(selectedNeedsHelpWith.Contains(subject) ? "badge-filter-active" : "badge-filter-nonactive")">
                                @subject.GetDisplayName()
                            </span>
                        </label>
                    }
                </div>
            </fieldset>
        </div>

        </div>

    </div>

    <div class="mt-auto sf-btn-row-noflex">
        <button class="btn-filter-primary" @onclick="async () => AutoFilter()">Автоматичен избор</button>
        <button class="btn-filter-secondary" @onclick="async () => ResetFilters()">Махни филтрите</button>
    </div>

    <hr />

    @* Списък с ученици *@
    @if (filteredStudents.Count == 0)
    {
        <div class="text-found-students"> 
            <p>Няма намерени ученици.</p>
        </div>
    }
    else
    {
        <div class="text-found-students">
            <p>Намерени ученици: @filteredStudents.Count</p>
        </div>
        <div class="students-container">
            @foreach (var student in filteredStudentsCompatib)
            {
                bool isAlreadyRequestedByMe = student.swap?.Status == SwapStatus.Pending && student.swap.RequesterId == currentStudent.Id;
                bool isAlreadyRequestedByOther = student.swap?.Status == SwapStatus.Pending && student.swap.RequesterId == student.student.Id;
                bool isAlreadySwapped = student.swap?.Status == SwapStatus.Confirmed || student.swap?.Status == SwapStatus.PendingCompleted || student.swap?.Status == SwapStatus.CompletedNotRated;

                bool canRequestHelp = student.student.CanHelpWith?.Where(s => s != SubjectEnum.NotSpecified).Intersect(currentStudent.NeedsHelpWith).ToHashSet().Count > 0;
                bool canOfferHelp = student.student.NeedsHelpWith?.Where(s => s != SubjectEnum.NotSpecified).Intersect(currentStudent.CanHelpWith).ToHashSet().Count > 0;

                <div class="student-card1">
                    @* Профилна, име и клас *@
                    <div class="student-header">
                        <img src="@AvatarManager.GetAvatarUrl(student.student.AvatarName)" alt="Avatar" class="filter-avatar" />
                        <div class="student-info">
                            <h4 class="student-name">@student.student.FirstName @student.student.SecName</h4>
                            <p class="student-grade">Клас: @student.student.Grade</p>
                        </div>
                    </div>

                    @* Предмети *@
                    <div class="student-subjects">
                        <div class="subjects-and-label-container">
                            <p class="text-label-help">Може да помогне с:</p>
                            <div class="subjects-only-container">
                                @foreach (var subj in student.student.CanHelpWith.Where(s => s != SubjectEnum.NotSpecified))
                                {
                                    var isMatch = selectedCanHelpWith.Contains(subj);
                                    <span class="badge @(isMatch ? "badge-match1" : "badge-nonmatch")">@subj.GetDisplayName()</span>
                                }
                            </div>
                        </div>

                        <div class="subjects-and-label-container">
                            <p class="text-label-help">Търси помощ по:</p>
                            <div class="subjects-only-container">
                                @foreach (var subj in student.student.NeedsHelpWith.Where(s => s != SubjectEnum.NotSpecified))
                                {
                                    var isMatch = selectedNeedsHelpWith.Contains(subj);
                                    <span class="badge @(isMatch ? "badge-match1" : "badge-nonmatch")">@subj.GetDisplayName()</span>
                                }
                            </div>
                        </div>
                    </div>

                    @* Бутони *@
                    <div class="mt-auto sf-btn-row">
                        @if (student.student.Grade == currentStudent?.Grade)
                        {
                            @if (!isAlreadyRequestedByMe && !isAlreadyRequestedByOther && !isAlreadySwapped)
                            {
                                <button class="btn-primary" @onclick="() => OpenModal(student.student, true)"> Помоли за помощ</button>
                                <button class="btn-primary" @onclick="() => OpenModal(student.student, false)">Предложи помощ</button>
                            }
                            else if (isAlreadyRequestedByMe && !isAlreadyRequestedByOther && !isAlreadySwapped)
                            {
                                <p>Очаквай приемането на заявката ти</p>
                                <button class="btn-warn" @onclick="() => CancelSwapRequest(student.swap)">Отмяна</button>
                            }
                            else if (!isAlreadyRequestedByMe && isAlreadyRequestedByOther && !isAlreadySwapped)
                            {
                                    <div class="d-flex align-items-center flex-nowrap">
                                        @if (student.swap.Student1Id == student.student.Id)
                                        {
                                            <span class="text small fw-semibold me-2">Иска да помогнеш по <strong>@student.swap.SubjectForHelp.GetDisplayName().ToLower()</strong></span>
                                        }
                                        else
                                        {
                                            <span class="text small fw-semibold me-2">Предлага ти помощ по <strong>@student.swap.SubjectForHelp.GetDisplayName().ToLower()</strong></span>
                                        }
                                    </div>
                                    <button class="btn-success" @onclick="() => ConfirmSwaps(student.swap)"><i class="bi bi-check fs-6"></i> Приеми</button>
                                    <button class="btn-danger" @onclick="() => RejectSwaps(student.swap)"><i class="bi bi-x fs-6"></i> Отхвърли</button>
                            }
                            else if (!isAlreadyRequestedByMe && !isAlreadyRequestedByOther && isAlreadySwapped)
                            {
                                <button class="btn-primary" @onclick="() => GoToSwapDetails(student.swap)">Виж свапа</button>
                            }
                            <button class="btn-secondary" @onclick="() => ViewProfile(student.student)">Виж профила</button>
                        }
                        else
                        {
                            <button class="btn-secondary" @onclick="() => ViewProfile(student.student)">Виж профила</button>
                        }
                    </div>
                </div>
            }
        </div>
    }
}

    <ModalRequestSwap IsOpen="@modalOpen"
                      student="@modalTargetStudent"
                      otherStudent="@currentStudent"
                      isRequiringHelp="@modalIsHelping"
                      OnClose="HandleSwapRequest" />

</div>

@code {
    private Student? currentStudent;

    private HashSet<int> allGrades = new();
    private HashSet<SubjectEnum> allSubjects = new();
    private List<Student> allStudents = new();

    private HashSet<int> selectedGrades = new();
    private HashSet<SubjectEnum> selectedCanHelpWith = new();
    private HashSet<SubjectEnum> selectedNeedsHelpWith = new();

    private List<Student> filteredStudents = new();
    private List<(Student student, double compatibility, HashSet<SubjectEnum> commonCan, HashSet<SubjectEnum> commonNeeds, Swap swap)> filteredStudentsCompatib = new();

    private bool modalOpen = false;
    private Student modalTargetStudent;
    private bool modalIsHelping;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        if (!user.Identity.IsAuthenticated)
        {
            currentStudent = null;
            return;
        }

        var username = user.Identity.Name;

        currentStudent = await StudentManager.FindStudent(s => s.Username == username);

        if (currentStudent == null)
        {
            return;
        }

        if (currentStudent != null)
        {
            List<Student> allStudents1 = await StudentManager.GetAllStudents();
            allStudents = allStudents1.Where(s => s.Id != currentStudent.Id).GroupBy(s => s.Id).Select(g => g.First()).ToList();


            allSubjects = Enum.GetValues(typeof(SubjectEnum)).Cast<SubjectEnum>().Where(s => s != SubjectEnum.NotSpecified).ToHashSet();
            allGrades = Enumerable.Range(4, 9).ToHashSet();

            await AutoFilter();
            await ApplyFilter();
        }
    }

    private async Task ApplyFilter()
    {
        filteredStudents = allStudents.Where(s =>
            ((selectedCanHelpWith.Count == 0 || s.CanHelpWith.Overlaps(selectedCanHelpWith)) ||
            (selectedNeedsHelpWith.Count == 0 || s.NeedsHelpWith.Overlaps(selectedNeedsHelpWith))) &&
            (selectedGrades.Count == 0 || selectedGrades.Contains(s.Grade))).ToList();

        filteredStudentsCompatib.Clear();
        foreach (var student in filteredStudents)
        {
            var compatibility = CalculateCompatibility(student, out HashSet<SubjectEnum> commonCan, out HashSet<SubjectEnum> commonNeeds);
            SwapModel? swap = await SwapManager.FindSwapByStudentsId(student.Id, currentStudent.Id);
            filteredStudentsCompatib.Add((student, compatibility, commonCan, commonNeeds, swap));
        }
        filteredStudentsCompatib = filteredStudentsCompatib.OrderByDescending(s => s.compatibility).ToList();
    }

    private async Task AutoFilter()
    {
        selectedCanHelpWith = currentStudent.NeedsHelpWith.ToHashSet();
        selectedNeedsHelpWith = currentStudent.CanHelpWith.ToHashSet();
        selectedGrades.Clear();
        selectedGrades.Add(currentStudent.Grade);
        await ApplyFilter();
    }

    private async Task ResetFilters()
    {
        selectedGrades.Clear();
        selectedCanHelpWith.Clear();
        selectedNeedsHelpWith.Clear();

        await ApplyFilter();
    }

    private async Task ToggleGrade(int grade, bool isChecked)
    {
        if (isChecked) selectedGrades.Add(grade);
        else selectedGrades.Remove(grade);
        await ApplyFilter();
    }

    private async Task ToggleSubject(SubjectEnum subject, bool isChecked, HashSet<SubjectEnum> targetList)
    {
        if (isChecked) targetList.Add(subject);
        else targetList.Remove(subject);
        await ApplyFilter();
    }

    private double CalculateCompatibility(Student student, out HashSet<SubjectEnum> commonCan, out HashSet<SubjectEnum> commonNeeds)
    {
        commonCan = student.CanHelpWith?.Where(s => s != SubjectEnum.NotSpecified).Intersect(selectedCanHelpWith).ToHashSet();
        commonNeeds = student.NeedsHelpWith?.Where(s => s != SubjectEnum.NotSpecified).Intersect(selectedNeedsHelpWith).ToHashSet();


        List<int> starRatings = RateHelpManager.LoadReviewsForStudentFromDb(student.Id).Select(r => r.Rating).ToList();

        if (selectedCanHelpWith.Count == 0 && selectedNeedsHelpWith.Count == 0)
            return 0 + ((student.HelpGivenCount == 0) ? 0 : (starRatings.Sum() / student.HelpGivenCount));

        else if (selectedCanHelpWith.Count == 0 && selectedNeedsHelpWith.Count > 0)
            return ((double)commonNeeds.Count / selectedNeedsHelpWith.Count) * 100 + ((student.HelpGivenCount == 0) ? 0 : (starRatings.Sum() / student.HelpGivenCount));

        else if (selectedCanHelpWith.Count > 0 && selectedNeedsHelpWith.Count == 0)
            return ((double)commonCan.Count / selectedCanHelpWith.Count) * 100 + ((student.HelpGivenCount == 0) ? 0 : (starRatings.Sum() / student.HelpGivenCount));

        else
            return (((double)commonCan.Count / selectedCanHelpWith.Count) + ((double)commonNeeds.Count / selectedNeedsHelpWith.Count)) / 2 * 100 + ((student.HelpGivenCount == 0) ? 0 : (starRatings.Sum() / student.HelpGivenCount));
    }

    private void ConfirmSwaps(SwapModel swap)
    {
        SwapManager.ConfirmSwap(swap);
    }
    private void RejectSwaps(SwapModel swap)
    {
        SwapManager.RejectSwap(swap);
    }
    private void CancelSwapRequest(SwapModel swap)
    {
        SwapManager.DeleteSwapFromDb(swap);
    }

    private void ViewProfile(Student student)
    {
        Navigation.NavigateTo($"/other-profile/{student.Id}");
    }


    private void OpenModal(Student target, bool isHelping)
    {
        modalTargetStudent = target;
        modalIsHelping = isHelping;
        modalOpen = true;
    }

    private async Task HandleSwapRequest((SubjectEnum? subject, string? comment) data)
    {
        modalOpen = false;

        if (!data.subject.HasValue || modalTargetStudent == null || currentStudent == null)
            return;

        Swap swap;

        if (modalIsHelping)
        {
            swap = await SwapManager.RequestHelp(currentStudent, modalTargetStudent, data.subject.Value, currentStudent, data.comment);
        }
        else
        {
            swap = await SwapManager.OfferHelp(modalTargetStudent, currentStudent, data.subject.Value, currentStudent, data.comment);
        }

        if (swap != null)
        {
            Guid studentId = (swap.RequesterId == swap.Student1Id) ? swap.Student2Id : swap.Student1Id;
            await swapHubContext.Clients.User(studentId.ToString()).SendAsync("NewSwaps");
        }

        modalTargetStudent = null;
        await InvokeAsync(StateHasChanged);
    }


    private void GoToSwapDetails(SwapModel swap)
    {
        Navigation.NavigateTo($"/chat/{swap.Id}");
    }


    private static bool ValueToBool(object? value)
    {
        if (value is bool b) return b;
        var s = value?.ToString();
        if (string.IsNullOrEmpty(s)) return false;
        return s.Equals("true", StringComparison.OrdinalIgnoreCase)
            || s.Equals("on", StringComparison.OrdinalIgnoreCase)
            || s.Equals("1");
    }
}