@page "/my-swaps" // страница за преглед на мои заявки, заявки към мен и текущи партньори
@inject NavigationManager Navigation
@inject AppState AppState
@inject StudentManager StudentManager
@inject AvatarService AvatarService
@inject SwapManager SwapManager
@rendermode InteractiveServer
@using SwapModel = BlazorApp6.Models.Swap

@if (currentStudent == null)
{
    <p>Моля, влезте в профила си</p>
}
else
{
    <div class="tabs">
        <button class="@GetTabClass("pairs")" @onclick='@(() => SelectTab("pairs"))'>Моите свапове</button>
        <button class="@GetTabClass("incoming")" @onclick='@(() => SelectTab("incoming"))'>Заявки към мен</button>
        <button class="@GetTabClass("outgoing")" @onclick='@(() => SelectTab("outgoing"))'>Моите заявки</button>
    </div>

    <div class="tab-content mb-3">
        @* Текущи свапове *@
        @if (selectedTab == "pairs")
        {
            @if (pairs.Count == 0)
            {
                <p>Нямате текущи свапове.</p>
            }
            else
            {
                <p>Текущите ви свапове: @pairs.Count</p>
                <div class="row g-3">
                    @foreach (SwapModel swap in pairs)
                    {
                        var student = StudentManager.FindStudent(s => s.Id == ((swap.Student1Id == currentStudent.Id) ? swap.Student2Id : swap.Student1Id));
                        bool currentStHelps = swap.Student1Id == currentStudent.Id;
                        @if (student == null) continue;

                        <div class="col-12 col-md-6">
                            <div class="card h-100 shadow-sm rounded-3 p-3 d-flex flex-column">

                                @* Профилна, име и клас *@
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <img src="@AvatarService.GetAvatarUrl(student.AvatarName)" alt="Avatar" />
                                         class="rounded-circle avatar-lg" />
                                    <div>
                                        <h5 class="fw-semibold mb-1">@student.FirstName @student.SecName</h5>
                                        <p class="text-muted small mb-0">Клас: @student.Grade</p>
                                    </div>
                                </div>
                                <hr />

                                @* Предмет *@
                                <div class="d-flex align-items-center justify-content-between flex-nowrap mb-2">
                                    <div class="d-flex align-items-center flex-nowrap">
                                        @if (currentStHelps)
                                        {
                                            <span class="text small fw-semibold me-2">Помагаш по: </span>
                                        }
                                        else
                                        {
                                            <span class="text small fw-semibold me-2">Помага ти по: </span>
                                        }
                                        <span class="badge rounded-pill px-3 py-1 me-2 badge-match">@swap.SubjectForHelp.GetDisplayName()</span>
                                    </div>

                                    @* Бутони *@
                                    <div class="ms-3">
                                        <button class="btn btn-outline-secondary flex-fill" @onclick="() => GoToSwap(swap.Id)">Виж детайли</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        }
        @* Заявки, които изпратиха на мен *@
        else if (selectedTab == "incoming")
        {
            @if (incomingSwaps.Count == 0)
            {
                <p>Все още никой не ти е продложил кооперация.</p>
            }
            else
            {
                @if (incomingSwaps.Count == 1)
                {
                    <p>1 ученик ти предложи помощ.</p>
                }
                else
                {
                    <p>@incomingSwaps.Count ученика ти преложиха помощ.</p>
                }
                <div class="row g-3">
                    @foreach (SwapModel swap in incomingSwaps)
                    {
                        var student = StudentManager.FindStudent(s => s.Id == swap.RequesterId);

                        int swapRequestCount = SwapManager.FindSwapsByStudentId(currentStudent.Id).Where(s => s.Status == SwapStatus.Pending).Count();
                        int swapActiveCount = SwapManager.FindSwapsByStudentId(currentStudent.Id).Where(s => s.Status == SwapStatus.Confirmed).Count();

                        int otherSwapRequestCount = SwapManager.FindSwapsByStudentId(student.Id).Where(s => s.Status == SwapStatus.Pending).Count();
                        int otherSwapActiveCount = SwapManager.FindSwapsByStudentId(student.Id).Where(s => s.Status == SwapStatus.Confirmed).Count();

                        if (student == null) continue;

                        <div class="col-12 col-md-6">
                            <div class="card h-100 shadow-sm rounded-3 p-3 d-flex flex-column">

                                @* Профилна, име и клас *@
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <img src="@AvatarService.GetAvatarUrl(student.AvatarName)" alt="Avatar" />
                                         class="rounded-circle avatar-lg" />
                                    <div>
                                        <h5 class="fw-semibold mb-1">@student.FirstName @student.SecName</h5>
                                        <p class="text-muted small mb-0">Клас: @student.Grade</p>
                                    </div>
                                </div>
                                <hr />

                                @* Списък с предмети *@
                                <div class="d-flex flex-column flex-grow-1">

                                    <p class="text small mb-2 fw-semibold">Може да помогне с:</p>
                                    <div class="match-subjects-scroll mb-2">
                                        @foreach (var subj in student.CanHelpWith.Where(s => s != SubjectEnum.NotSpecified))
                                        {
                                            var isMatch = currentStudent.NeedsHelpWith.Contains(subj);
                                            <span class="badge rounded-pill px-3 py-1 me-2 @(isMatch ? "badge-match" : "badge-nonmatch")">
                                                @subj.GetDisplayName()
                                            </span>
                                        }
                                    </div>

                                    <p class="text small mb-2 fw-semibold">Търси помощ по:</p>
                                    <div class="match-subjects-scroll mb-2">
                                        @foreach (var subj in student.NeedsHelpWith.Where(s => s != SubjectEnum.NotSpecified))
                                        {
                                            var isMatch = currentStudent.CanHelpWith.Contains(subj);
                                            <span class="badge rounded-pill px-3 py-1 me-2 @(isMatch ? "badge-match" : "badge-nonmatch")">
                                                @subj.GetDisplayName()
                                            </span>
                                        }
                                    </div>

                                    @* Бутони "Приеми/откажи заявката" и "Виж профила" *@
                                    <div class="mt-auto d-flex gap-2">
                                        <button class="btn btn-primary" disabled="@((swapRequestCount > 10 || swapActiveCount > 3) || (otherSwapRequestCount > 10 || otherSwapActiveCount > 3))" @onclick="() => ConfirmSwap(swap)">Приеми заявката</button>
                                        <button class="btn btn-danger" @onclick="() => RejectSwap(swap)">Откажи заявката</button>
                                        <button class="btn btn-outline-secondary flex-fill" @onclick="() => ViewProfile(student)">Виж профила</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

            }
        }

        @* Заявки, които съм изпратил *@
        else if (selectedTab == "outgoing")
        {
            @if (outgoingSwaps.Count == 0)
            {
                <p>Още на никого не си предложил кооперация.</p>
            }
            else
            {
                <p>Намерени ученици: @outgoingSwaps.Count</p>
                <div class="row g-3">
                    @foreach (SwapModel swap in outgoingSwaps)
                    {
                        var student = StudentManager.FindStudent(s => (s.Id == swap.Student1Id || s.Id == swap.Student2Id) && s.Id != currentStudent.Id);
                        if (student == null) continue;

                        <div class="col-12 col-md-6">
                            <div class="card h-100 shadow-sm rounded-3 p-3 d-flex flex-column">

                                @* Профилна, име и клас *@
                                <div class="d-flex align-items-center gap-3 mb-3">
                                    <img src="@AvatarService.GetAvatarUrl(student.AvatarName)" alt="Avatar" />
                                         class="rounded-circle avatar-lg" />
                                    <div>
                                        <h5 class="fw-semibold mb-1">@student.FirstName @student.SecName</h5>
                                        <p class="text-muted small mb-0">Клас: @student.Grade</p>
                                    </div>
                                </div>
                                <hr />

                                @* Списък с предмети *@
                                <div class="d-flex flex-column flex-grow-1">

                                    <p class="text small mb-2 fw-semibold">Може да помогне с:</p>
                                    <div class="match-subjects-scroll mb-2">
                                        @foreach (var subj in student.CanHelpWith.Where(s => s != SubjectEnum.NotSpecified))
                                        {
                                            var isMatch = currentStudent.NeedsHelpWith.Contains(subj);
                                            <span class="badge rounded-pill px-3 py-1 me-2 @(isMatch ? "badge-match" : "badge-nonmatch")">
                                                @subj.GetDisplayName()
                                            </span>
                                        }
                                    </div>

                                    <p class="text small mb-2 fw-semibold">Търси помощ по:</p>
                                    <div class="match-subjects-scroll mb-2">
                                        @foreach (var subj in student.NeedsHelpWith.Where(s => s != SubjectEnum.NotSpecified))
                                        {
                                            var isMatch = currentStudent.CanHelpWith.Contains(subj);
                                            <span class="badge rounded-pill px-3 py-1 me-2 @(isMatch ? "badge-match" : "badge-nonmatch")">
                                                @subj.GetDisplayName()
                                            </span>
                                        }
                                    </div>

                                    @* Бутини "Отмени заявката ми" и "Виж профила" *@
                                    <div class="mt-auto d-flex gap-2">
                                        <button class="btn btn-warning" @onclick="() => CancelSwapRequest(swap)">Отмени заявката ми</button>
                                        <button class="btn btn-outline-secondary flex-fill" @onclick="() => ViewProfile(student)">Виж профила</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        }
    </div>
}

@code {
    private Student? currentStudent;
    private string selectedTab = "pairs";

    private List<SwapModel> pairs = new();
    private List<SwapModel> incomingSwaps = new();
    private List<SwapModel> outgoingSwaps = new();

    protected override void OnParametersSet()
    {
        currentStudent = AppState.CurrentUser;
        if (currentStudent == null) return;

        LoadData();
    }

    private void LoadData()
    {
        List<SwapModel> swaps = SwapManager.FindSwapsByStudentId(currentStudent.Id);

        pairs = swaps.Where(m => m.Status == SwapStatus.Confirmed || m.Status == SwapStatus.CompletedNotRated || m.Status == SwapStatus.PendingCompleted).ToList();
        incomingSwaps = swaps.Where(m => m.RequesterId != currentStudent.Id && m.Status == SwapStatus.Pending).ToList();
        outgoingSwaps = swaps.Where(m => m.RequesterId == currentStudent.Id && m.Status == SwapStatus.Pending).ToList();
    }

    private void SelectTab(string tab)
    {
        selectedTab = tab;
    }
    private string GetTabClass(string tab)
    {
        return (selectedTab == tab) ? "btn btn-primary me-2" : "btn btn-outline-primary me-2";
    }

    private void ConfirmSwap(SwapModel swap)
    {
        SwapManager.ConfirmSwap(swap);
        LoadData();
    }

    private void RejectSwap(SwapModel swap)
    {
        SwapManager.RejectSwap(swap);
        LoadData();
    }

    private void CancelSwapRequest(SwapModel swap)
    {
        SwapManager.CancelMyRequest(swap);
        LoadData();
    }

    private void CompleteSwap(SwapModel swap)
    {
        SwapManager.CompleteSwap(swap);
        LoadData();
    }

    private void GoToSwap(Guid Id)
    {
        Navigation.NavigateTo($"/chat/{Id}");
    }
    private void ViewProfile(Student student)
    {
        Navigation.NavigateTo($"/other-profile/{student.Id}");
    }
    private string GetAvatarUrl(Student student)
    {
        // Вернуть URL аватарки, пока заглушка
        return "_content/YourAppNamespace/images/default-avatar.png";
    }
}


<style>
    .match-subjects-scroll {
        overflow-x: auto;
        display: flex;
        gap: 0.5rem;
        scrollbar-width: thin;
    }

        .match-subjects-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .match-subjects-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.15);
            border-radius: 3px;
        }

    .badge-match {
        background-color: #a8d0ff; /* более яркий светло-синий */
        color: #003366;
        font-weight: 600;
    }

    .badge-nonmatch {
        background-color: #e6f0ff; /* более бледный */
        color: #555;
        font-weight: 400;
    }
</style>