@page "/other-profile/{Id:guid}"
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Forms
@inject IHttpContextAccessor HttpContextAccessor
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject StudentManager StudentManager
@inject AvatarManager AvatarManager
@inject SwapManager SwapManager
@inject RateHelpManager RateHelpManager
@inject OnlineUsersService OnlineUsers
@rendermode InteractiveServer
@using SwapModel = BlazorApp6.Models.Swap

<div class="main-page">

    @if (currentStudent == null)
    {
        <p>Моля, влезте в профила си</p>
    }

    else if (string.IsNullOrEmpty(errorMessage) && otherStudent != null)
    {
        SwapModel? swap = SwapManager.FindSwapByStudentsId(otherStudent.Id, currentStudent.Id);

        bool isAlreadyRequested = swap?.Status == SwapStatus.Pending;
        bool isAlreadySwapped = swap?.Status == SwapStatus.Confirmed;

        bool canRequestHelp =
        otherStudent.CanHelpWith?.Where(s => s != SubjectEnum.NotSpecified)
        .Intersect(currentStudent.NeedsHelpWith).Any() == true;

        bool canOfferHelp =
        otherStudent.NeedsHelpWith?.Where(s => s != SubjectEnum.NotSpecified)
        .Intersect(currentStudent.CanHelpWith).Any() == true;

        int swapRequestCount = SwapManager.FindSwapsByStudentId(currentStudent.Id)
        .Count(s => s.Status == SwapStatus.Pending);

        int swapActiveCount = SwapManager.FindSwapsByStudentId(currentStudent.Id)
        .Count(s => s.Status == SwapStatus.Confirmed);

        int otherSwapRequestCount = SwapManager.FindSwapsByStudentId(otherStudent.Id)
        .Count(s => s.Status == SwapStatus.Pending);

        int otherSwapActiveCount = SwapManager.FindSwapsByStudentId(otherStudent.Id)
        .Count(s => s.Status == SwapStatus.Confirmed);

        allSwaps = SwapManager.FindSwapsByStudentId(otherStudent.Id);
        averageRating = (otherStudent.HelpGivenCount == 0)
        ? 0
        : starRatings.Sum() / otherStudent.HelpGivenCount;

        <div class="profile-all-containers">

            <!-- ===== ГОРНА ЧАСТ ===== -->
            <div class="profile-main-info-container">
                <div class="avatar-wrapper">
                    <img src="@AvatarManager.GetAvatarUrl(otherStudent.AvatarName)"
                         class="profile-avatar"
                         alt="Avatar" />

                    <span class="online-dot @(isOnline ? "online" : "offline")"></span>
                </div>

                <div class="profile-username-grade-container">
                    <p class="text-username">
                        @otherStudent.FirstName @otherStudent.SecName
                    </p>
                    <p class="text-grade">
                        @otherStudent.Grade клас
                    </p>
                </div>
            </div>

            <!-- ===== ЛЯВА ЧАСТ ===== -->
            <div class="profile-sections">

                <!-- СТАТИСТИКА -->
                <div class="profile-container-stats">
                    <div class="stat-all">
                        <p class="stat-value">
                            @allSwaps.Count(s =>
                            s.Status == SwapStatus.Confirmed ||
                            s.Status == SwapStatus.PendingCompleted ||
                            s.Status == SwapStatus.CompletedNotRated)
                    </p>
                    <p class="stat-label">Активни свапове</p>
                </div>

                <div class="stat-all">
                    <p class="stat-value">@allSwaps.Count()</p>
                    <p class="stat-label">Общо свапове</p>
                </div>

                <div class="stat-all">
                    <p class="stat-value">@Math.Round(averageRating, 1)</p>
                    <p class="stat-label">Рейтинг</p>
                </div>

                <div class="stat-all">
                    <p class="stat-value">@otherStudent.Coins</p>
                    <p class="stat-label">Монети</p>
                </div>
            </div>

            <!-- ЛИЧНА ИНФОРМАЦИЯ -->
            <div class="profile-container-persinfo">
                <div>
                    <p class="profile-text-help-with">Мога да помогна по:</p>
                    <div class="subjects-only-container mt-lg-2">
                        @foreach (var subj in otherStudent.CanHelpWith)
                            {
                                <span class="badge badge-match1">@subj.GetDisplayName()</span>
                            }
                        </div>
                    </div>

                    <div>
                        <p class="profile-text-help-with">Търся помощ по:</p>
                        <div class="subjects-only-container mt-lg-2">
                            @foreach (var subj in otherStudent.NeedsHelpWith)
                            {
                                <span class="badge badge-match1">@subj.GetDisplayName()</span>
                            }
                        </div>
                    </div>

                    @if (!isAlreadyRequested && isAlreadySwapped)
                    {
                        <p><strong>Имейл:</strong> @otherStudent.Email</p>
                    }

                    @if (!isAlreadyRequested && !isAlreadySwapped)
                    {
                        <button class="btn-profile-secondary"
                                disabled="@(!canRequestHelp || swapRequestCount > 10 || swapActiveCount > 3 || otherSwapRequestCount > 10 || otherSwapActiveCount > 3)"
                                @onclick="() => OpenModal(otherStudent, true)">
                            Помоли за помощ
                        </button>

                        <button class="btn-profile-secondary"
                                disabled="@(!canOfferHelp || swapRequestCount > 10 || swapActiveCount > 3 || otherSwapRequestCount > 10 || otherSwapActiveCount > 3)"
                                @onclick="() => OpenModal(otherStudent, false)">
                            Предложи помощ
                        </button>
                                }
                    else if (isAlreadyRequested && !isAlreadySwapped)
                    {
                        <p>Очаква се приемане на заявката ти</p>
                        <button class="btn-profile-secondary-warn"
                                @onclick="() => CancelSwapRequest(swap!)">
                            Отмени заявката ми
                        </button>
                    }
                    else if (isAlreadySwapped)
                    {
                        <button class="btn-profile-secondary"
                                @onclick="() => GoToSwapDetails(swap!)">
                            Виж свапа
                        </button>
                    }
                </div>
            </div>

            <!-- ===== ОТЗИВИ ===== -->
            <div class="profile-reviews-container">
                <p class="profile-maintext">Отзиви</p>
                <p class="profile-sectext">от ученици, на когото е помогнал(а)</p>

                @if (reviews.Count == 0)
                {
                    <p class="no-reviews-text">Все още няма отзиви за този ученик.</p>
                }
                else
                {
                    @foreach (var r in reviews)
                    {
                        var sender = StudentManager.FindStudent(s => s.Id == r.SenderStudentId);
                        var otherSwap = SwapManager.FindHistorySwapByStudentsId(otherStudent.Id, sender.Id);

                        <div class="review-card">
                            <img src="@AvatarManager.GetAvatarUrl(sender.AvatarName)" class="review-avatar" />

                           <div class="review-content">
                                <div class="review-header">
                                    <span class="review-name" @onclick="() => GoToOtherProfiile(sender.Id)">
                                        @sender.FirstName
                                    </span>
                                    <span class="review-subject">@otherSwap.SubjectForHelp.GetDisplayName()</span>
                                </div>

                                <div class="review-stars">
                                    @for (int i = 0; i < r.Rating; i++)
                                    {
                                        <span>&#9733;</span>
                                    }
                                </div>

                                <p class="review-comment">“@r.Comment”</p>
                            </div>
                        </div>
                    }   
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }
</div>

<ModalRequestSwap IsOpen="@modalOpen"
                  student="@modalTargetStudent"
                  otherStudent="@currentStudent"
                  isRequiringHelp="@modalIsHelping"
                  OnClose="SendRequestForSwapAndCloseModal" />

@code {
    [Parameter] public Guid Id { get; set; }

    private Student? otherStudent;
    private Student? currentStudent;

    private List<Swap> allSwaps = new();
    private List<int> starRatings = new();
    private double averageRating;
    private List<Review> reviews = new();

    private bool modalOpen;
    private Student? modalTargetStudent;
    private bool modalIsHelping;

    bool isOnline { get; set; }

    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        if (!user.Identity.IsAuthenticated)
        {
            currentStudent = null;
            return;
        }

        currentStudent = StudentManager.FindStudent(s => s.Username == user.Identity.Name);

        if (Id == Guid.Empty)
        {
            errorMessage = "Невалиден id.";
            return;
        }

        otherStudent = StudentManager.FindStudent(s => s.Id == Id);

        if (otherStudent == null)
            errorMessage = "Ученикът не беше намерен.";

        isOnline = OnlineUsers.IsOnline(otherStudent.Id);

        starRatings = RateHelpManager.LoadReviewsForStudentFromDb(otherStudent.Id).Select(r => r.Rating).ToList();

        reviews = RateHelpManager.LoadReviewsForStudentFromDb(otherStudent.Id);
    }

    private void CancelSwapRequest(SwapModel swap) =>
        SwapManager.CancelMyRequest(swap);

    private void OpenModal(Student target, bool isHelping)
    {
        modalTargetStudent = target;
        modalIsHelping = isHelping;
        modalOpen = true;
    }

    private void SendRequestForSwapAndCloseModal(SubjectEnum? subject)
    {
        modalOpen = false;

        if (subject.HasValue && modalTargetStudent != null && currentStudent != null)
        {
            if (modalIsHelping)
                SwapManager.OfferHelp(modalTargetStudent, currentStudent, subject.Value, currentStudent);
            else
                SwapManager.RequestHelp(currentStudent, modalTargetStudent, subject.Value, currentStudent);
        }
    }

    private void GoToSwapDetails(SwapModel swap) =>
        NavigationManager.NavigateTo($"/chat/{swap.Id}");

    private void GoToOtherProfiile(Guid studentId)
    {
        NavigationManager.NavigateTo($"/other-profile/{studentId}");
    }
}