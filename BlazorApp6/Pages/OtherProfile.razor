@page "/other-profile/{Id:guid}"
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Forms
@inject IHttpContextAccessor HttpContextAccessor
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject NavigationManager NavigationManager
@inject StudentManager StudentManager
@inject AvatarManager AvatarManager
@inject SwapManager SwapManager
@inject RateHelpManager RateHelpManager
@inject OnlineUsersService OnlineUsers
@inject IHubContext<SwapHub> swapHubContext
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR
@using SwapModel = BlazorApp6.Models.Swap

<div class="main-page">

    @if (currentStudent == null)
    {
        <p>Моля, влезте в профила си</p>
    }

    else if (string.IsNullOrEmpty(errorMessage) && otherStudent != null)
    {
        bool isAlreadyRequested = swap?.Status == SwapStatus.Pending;
        bool isAlreadySwapped = swap?.Status == SwapStatus.Confirmed;

        bool canRequestHelp =
        otherStudent.CanHelpWith?.Where(s => s != SubjectEnum.NotSpecified)
        .Intersect(currentStudent.NeedsHelpWith).Any() == true;

        bool canOfferHelp =
        otherStudent.NeedsHelpWith?.Where(s => s != SubjectEnum.NotSpecified)
        .Intersect(currentStudent.CanHelpWith).Any() == true;

        averageRating = (otherStudent.HelpGivenCount == 0)
        ? 0
        : starRatings.Sum() / otherStudent.HelpGivenCount;

        <div class="profile-all-containers">

            <!-- ===== ГОРНА ЧАСТ ===== -->
            <div class="profile-main-info-container">
                <div class="avatar-wrapper">
                    <img src="@AvatarManager.GetAvatarUrl(otherStudent.AvatarName)"
                         class="profile-avatar"
                         alt="Avatar" />

                    <span class="online-dot @(isOnline ? "online" : "offline")"></span>
                </div>

                <div class="profile-username-grade-container">
                    <p class="text-username">
                        @otherStudent.FirstName @otherStudent.SecName
                    </p>
                    <p class="text-grade">
                        @otherStudent.Grade клас
                    </p>
                </div>
            </div>

            <!-- ===== ЛЯВА ЧАСТ ===== -->
            <div class="profile-sections">

                <!-- СТАТИСТИКА -->
                <div class="profile-container-stats">
                    <div class="stat-all">
                        <p class="stat-value">
                            @allSwaps.Count(s =>
                            s.Status == SwapStatus.Confirmed ||
                            s.Status == SwapStatus.PendingCompleted ||
                            s.Status == SwapStatus.CompletedNotRated)
                    </p>
                    <p class="stat-label">Активни свапове</p>
                </div>

                <div class="stat-all">
                    <p class="stat-value">@allSwaps.Count()</p>
                    <p class="stat-label">Общо свапове</p>
                </div>

                <div class="stat-all">
                    <p class="stat-value">@Math.Round(averageRating, 1)</p>
                    <p class="stat-label">Рейтинг</p>
                </div>

                <div class="stat-all">
                    <p class="stat-value">@otherStudent.Coins</p>
                    <p class="stat-label">Монети</p>
                </div>
            </div>

            <!-- ЛИЧНА ИНФОРМАЦИЯ -->
            <div class="profile-container-persinfo">
                <div>
                    <p class="profile-text-help-with">Мога да помогна по:</p>
                    <div class="subjects-only-container mt-lg-2">
                        @foreach (var subj in otherStudent.CanHelpWith)
                            {
                                <span class="badge badge-match1">@subj.GetDisplayName()</span>
                            }
                        </div>
                    </div>

                    <div>
                        <p class="profile-text-help-with">Търся помощ по:</p>
                        <div class="subjects-only-container mt-lg-2">
                            @foreach (var subj in otherStudent.NeedsHelpWith)
                            {
                                <span class="badge badge-match1">@subj.GetDisplayName()</span>
                            }
                        </div>
                    </div>

                    @if (!isAlreadyRequested && isAlreadySwapped)
                    {
                        <p><strong>Имейл:</strong> @otherStudent.Email</p>
                    }

                    @if (!isAlreadyRequested && !isAlreadySwapped)
                    {
                        <div style="display: flex; gap: 10px;">
                            <button class="btn-profile-secondary"
                                    @onclick="() => OpenModal(otherStudent, true)">
                                Помоли за помощ
                            </button>

                            <button class="btn-profile-secondary"
                                    @onclick="() => OpenModal(otherStudent, false)">
                                Предложи помощ
                            </button>
                        </div>
                    }
                    else if (isAlreadyRequested && !isAlreadySwapped)
                    {
                        <p>Очаква се приемане на заявката ти</p>
                        <button class="btn-warn"
                                @onclick="() => CancelSwapRequest(swap!)">
                            Отмени заявката ми
                        </button>
                    }
                    else if (isAlreadySwapped)
                    {
                        <button class="btn-profile-secondary"
                                @onclick="() => GoToSwapDetails(swap!)">
                            Виж свапа
                        </button>
                    }
                </div>
            </div>

            <!-- ===== ОТЗИВИ ===== -->
            <div class="profile-reviews-container">
                <p class="profile-maintext">Отзиви</p>
                <p class="profile-sectext">от ученици, на когото е помогнал(а)</p>

                @if (reviews.Count == 0)
                {
                    <p class="no-reviews-text">Все още няма отзиви за този ученик.</p>
                }
                else
                {
                    @foreach (var i in info)
                    {
                        <div class="review-card">
                            <img src="@AvatarManager.GetAvatarUrl(i.Sender.AvatarName)" class="review-avatar" />

                           <div class="review-content">
                                <div class="review-header">
                                    <span class="review-name" @onclick="() => GoToOtherProfiile(i.Sender.Id)">
                                        @i.Sender.FirstName
                                    </span>
                                    <span class="review-subject">@i.OtherSwap.SubjectForHelp.GetDisplayName()</span>
                                </div>

                                <div class="review-stars">
                                    @for (int f = 0; f < i.Reviews.Rating; f++)
                                    {
                                        <span>&#9733;</span>
                                    }
                                </div>

                                <p class="review-comment">“@i.Reviews.Comment”</p>
                            </div>
                        </div>
                    }   
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }
</div>

<ModalRequestSwap IsOpen="@modalOpen"
                  student="@modalTargetStudent"
                  otherStudent="@currentStudent"
                  isRequiringHelp="@modalIsHelping"
                  OnClose="HandleSwapRequest" />


@code {
    [Parameter] public Guid Id { get; set; }

    private Student? otherStudent;
    private Student? currentStudent;

    private SwapModel? swap;
    private List<Swap> allSwaps = new();
    private List<int> starRatings = new();
    private double averageRating;
    private List<Review> reviews = new();

    private List<(Review Reviews, Student Sender, Swap OtherSwap)> info = new();

    private bool modalOpen;
    private Student? modalTargetStudent;
    private bool modalIsHelping;

    bool isOnline { get; set; }

    private string errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        if (!user.Identity.IsAuthenticated)
        {
            currentStudent = null;
            return;
        }

        currentStudent = StudentManager.FindStudent(s => s.Username == user.Identity.Name);

        if (Id == Guid.Empty)
        {
            errorMessage = "Невалиден id.";
            return;
        }

        otherStudent = StudentManager.FindStudent(s => s.Id == Id);

        if (otherStudent == null)
            errorMessage = "Ученикът не беше намерен.";

        swap = await SwapManager.FindSwapByStudentsId(otherStudent.Id, currentStudent.Id);

        isOnline = OnlineUsers.IsOnline(otherStudent.Id);

        starRatings = RateHelpManager.LoadReviewsForStudentFromDb(otherStudent.Id).Select(r => r.Rating).ToList();

        reviews = RateHelpManager.LoadReviewsForStudentFromDb(otherStudent.Id);

        allSwaps = await SwapManager.FindSwapsByStudentId(otherStudent.Id);

        @foreach (var r in reviews)
        {
            var sender = StudentManager.FindStudent(s => s.Id == r.SenderStudentId);
            var otherSwap = await SwapManager.FindHistorySwapByStudentsId(otherStudent.Id, sender.Id);
            info.Add((r, sender, otherSwap));
        }
    }

    private void CancelSwapRequest(SwapModel swap) =>
        SwapManager.DeleteSwapFromDb(swap);

    private void OpenModal(Student target, bool isHelping)
    {
        modalTargetStudent = target;
        modalIsHelping = isHelping;
        modalOpen = true;
    }

    private async Task HandleSwapRequest((SubjectEnum? subject, string? comment) data)
    {
        modalOpen = false;

        if (!data.subject.HasValue || modalTargetStudent == null || currentStudent == null)
            return;

        Swap swap;

        if (modalIsHelping)
        {
            swap = await SwapManager.RequestHelp(currentStudent, modalTargetStudent, data.subject.Value, currentStudent, data.comment);
        }
        else
        {
            swap = await SwapManager.OfferHelp(modalTargetStudent, currentStudent, data.subject.Value, currentStudent, data.comment);
        }

        if (swap != null)
        {
            Guid studentId = (swap.RequesterId == swap.Student1Id) ? swap.Student2Id : swap.Student1Id;
            await swapHubContext.Clients.User(studentId.ToString()).SendAsync("NewSwaps");
        }

        modalTargetStudent = null;
        await InvokeAsync(StateHasChanged);
    }


    private void GoToSwapDetails(SwapModel swap) =>
        NavigationManager.NavigateTo($"/chat/{swap.Id}");

    private void GoToOtherProfiile(Guid studentId)
    {
        NavigationManager.NavigateTo($"/other-profile/{studentId}");
    }
}