@page "/ai-chat"
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager Navigation
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider Auth
@inject StudentManager StudentManager

<div class="chat-page">
    @* <div class="sidebar p-3">
        <h5>AI Учител</h5>
        <p>Помага с уроци и задачи</p>
    </div> *@

    <div class="chat-container d-flex flex-column flex-grow-1">
        <div class="chat-window flex-grow-1 overflow-auto">

            @foreach (var m in messages)
            {
                if (m.SenderId == currentStudent.Id)
                {
                    <div class="my-message">
                        @m.Content
                    </div>
                }
                else
                {
                    <div class="other-message-sender">
                        <div class="other-message">
                            @m.Content
                        </div>
                    </div>
                }
            }

            <div class="input-bar d-flex align-items-center gap-2 mt-2">
                @* <button class="btn btn-light rounded-circle" @onclick="ToggleEmojiPanel">😀</button> *@
                <InputFile OnChange="OnInputFileSelected" class="form-control-file" />
                <InputText @bind-Value="newMessage" placeholder="Напиши съобщение..." class="form-control flex-grow-1 type-message" />
                <button class="btn-primary-send-message" disabled="@string.IsNullOrWhiteSpace(newMessage)" @onclick="SendMessage">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>
</div>

@code {
    private HubConnection hub;
    private List<MessageVm> messages = new();
    private string newMessage;

    private Student currentStudent;

    protected override async Task OnInitializedAsync()
    {
        var state = await Auth.GetAuthenticationStateAsync();

        var userIdClaim = state.User.FindFirst("StudentId");
        if (userIdClaim == null)
            return;

        Guid studentId = Guid.Parse(userIdClaim.Value);

        currentStudent = StudentManager.FindStudent(s => s.Id == studentId);

        hub = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/aichat"))
            .Build();

        hub.On<Guid, Guid, string, string>("ReceiveMessage",
            (id, senderId, sender, msg) =>
            {
                messages.Add(new MessageVm(senderId, msg));
                InvokeAsync(StateHasChanged);
            });

        await hub.StartAsync();
    }

    private async Task SendMessage()
    {
        await hub.SendAsync(
            "SendMessage",
            $"{currentStudent.FirstName} {currentStudent.SecName}",
            currentStudent.Id,
            newMessage
        );

        newMessage = "";
    }

    private async Task OnInputFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        using var stream = file.OpenReadStream(20 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        byte[] fileBytes = ms.ToArray();

        await hub.SendAsync("SendFile",
            $"{currentStudent.FirstName} {currentStudent.SecName}",
            currentStudent.Id,
            file.Name,
            fileBytes);
    }


    class MessageVm
    {
        public Guid SenderId { get; }
        public string Content { get; }

        public MessageVm(Guid senderId, string content)
        {
            SenderId = senderId;
            Content = content;
        }
    }
}
