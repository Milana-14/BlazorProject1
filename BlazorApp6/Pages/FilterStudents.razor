@page "/students-filter" // страница за филтриране на ученици
@inject AppState AppState
@inject NavigationManager Navigation
@inject StudentManager StudentManager
@inject AvatarService AvatarService
@inject SwapManager SwapManager
@rendermode InteractiveServer
@using SwapModel = BlazorApp6.Models.Swap

<h3>Филтър</h3>

@if (currentStudent == null)
{
    <p>Моля, влезте в профила си</p>
}
else
{
    @* Филтър за клас *@
    <fieldset>
        <div class="buttons-row d-flex flex-wrap mb-1 gap-2">
            <button class="btn btn-sm btn-link" @onclick="SelectAllGrades">Избери всички</button>
            <button class="btn btn-sm btn-link" @onclick="ClearAllGrades">Изтрий</button>
        </div>
        <div class="filter-row">
            <div class="filter-label">Клас:</div>
            <div class="checkbox-group">
                @foreach (var grade in allGrades.OrderBy(g => g))
                {
                    <div class="form-check">
                        <input class="form-check-input" 
                               id=@($"grade_{grade}") type="checkbox"
                               checked=@(selectedGrades.Contains(grade))
                               @onchange="(ChangeEventArgs e) => ToggleGrade(grade, ValueToBool(e.Value))" />
                        <label class="form-check-label" for=@($"grade_{grade}")>@grade</label>
                    </div>
                }
            </div>
        </div>
    </fieldset>

    @* Филтри за предметите *@
    @* Може да помогне с: *@
    <fieldset>
        <div class="buttons-row d-flex flex-wrap mb-1 gap-2">
            <button class="btn btn-sm btn-link" @onclick="() => SelectAllSubjects(selectedCanHelpWith)">Избери всички</button>
            <button class="btn btn-sm btn-link" @onclick="() => ClearAllSubjects(selectedCanHelpWith)">Изтрий</button>
        </div>
        <div class="filter-row">
            <div class="filter-label">Може да помогне с:</div>
            <div class="checkbox-group">
                @foreach (var subject in allSubjects)
                {
                    <div class="form-check" @key="subject">
                        <input class="form-check-input"
                               id=@($"can_{subject}")
                               type="checkbox"
                               checked=@(selectedCanHelpWith.Contains(subject))
                               @onchange="(ChangeEventArgs e) => ToggleSubject(subject, ValueToBool(e.Value), selectedCanHelpWith)" />
                        <label class="form-check-label" for=@($"can_{subject}")>@subject.GetDisplayName()</label>
                    </div>
                }
            </div>
        </div>
    </fieldset>

    @* Търси помощ по: *@
    <fieldset>
        <div class="buttons-row d-flex flex-wrap mb-1 gap-2">
            <button class="btn btn-sm btn-link" @onclick="() => SelectAllSubjects(selectedNeedsHelpWith)">Избери всички</button>
            <button class="btn btn-sm btn-link" @onclick="() => ClearAllSubjects(selectedNeedsHelpWith)">Изтрий</button>
        </div>
        <div class="filter-row">
            <div class="filter-label">Търси помощ по:</div>
            <div class="checkbox-group">
                @foreach (var subject in allSubjects)
                {
                    <div class="form-check" @key="subject">
                        <input class="form-check-input"
                               id="@($"need_{subject}")"
                               type="checkbox"
                               checked=@selectedNeedsHelpWith.Contains(subject)
                               @onchange="(ChangeEventArgs e) => ToggleSubject(subject, ValueToBool(e.Value), selectedNeedsHelpWith)" />
                        <label class="form-check-label" for=@($"need_{subject}")>@subject.GetDisplayName()</label>
                    </div>
                }
            </div>
        </div>
    </fieldset>

    <button class="btn btn-primary me-2 mb-3" @onclick="AutoFilter">Автоматичен избор</button>
    <button class="btn btn-secondary mb-3" @onclick="ResetFilters">Махни филтрите</button>

    <hr />

    @* Списък с намерени ученици *@
    @if (filteredStudents.Count == 0)
    {
        <p>Няма намерени ученици.</p>
    }
    else
    {
        <p>Намерени ученици: @filteredStudents.Count</p>
        <div class="row g-3">
            @foreach (var student in filteredStudentsCompatib)
            {
                SwapModel? swap = SwapManager.FindSwapByStudentsId(student.student.Id, currentStudent.Id);

                bool isAlreadyRequested = swap?.Status == SwapStatus.Pending;
                bool isAlreadySwapped = swap?.Status == SwapStatus.Confirmed;

                bool canRequestHelp = student.student.CanHelpWith?.Where(s => s != SubjectEnum.NotSpecified).Intersect(currentStudent.NeedsHelpWith).ToHashSet().Count > 0;
                bool canOfferHelp = student.student.NeedsHelpWith?.Where(s => s != SubjectEnum.NotSpecified).Intersect(currentStudent.CanHelpWith).ToHashSet().Count > 0;

                int swapRequestCount = SwapManager.FindSwapsByStudentId(currentStudent.Id).Where(s => s.Status == SwapStatus.Pending).Count();
                int swapActiveCount = SwapManager.FindSwapsByStudentId(currentStudent.Id).Where(s => s.Status == SwapStatus.Confirmed).Count();

                int otherSwapRequestCount = SwapManager.FindSwapsByStudentId(student.student.Id).Where(s => s.Status == SwapStatus.Pending).Count();
                int otherSwapActiveCount = SwapManager.FindSwapsByStudentId(student.student.Id).Where(s => s.Status == SwapStatus.Confirmed).Count();

                <div class="col-12 col-md-6">
                    <div class="card h-100 shadow-sm rounded-3 p-3 d-flex flex-column">

                        @* Профилна, име и клас *@
                        <div class="d-flex align-items-center gap-3 mb-3">
                            <img src="@AvatarService.GetAvatarUrl(student.student.AvatarName)" alt="Avatar" />
                                 class="rounded-circle avatar-lg" />
                            <div>
                                <h5 class="fw-semibold mb-1">@student.student.FirstName @student.student.SecName</h5>
                                <p class="text-muted small mb-0">Клас: @student.student.Grade</p>
                            </div>
                        </div>
                        <hr />

                        @* Списък с предмети *@
                        <div class="d-flex flex-column flex-grow-1">

                            <p class="text small mb-2 fw-semibold">Може да помогне с:</p>
                            <div class="match-subjects-scroll mb-2">
                                @foreach (var subj in student.student.CanHelpWith.Where(s => s != SubjectEnum.NotSpecified))
                                {
                                    var isMatch = selectedCanHelpWith.Contains(subj);
                                    <span class="badge rounded-pill px-3 py-1 me-2 @(isMatch ? "badge-match" : "badge-nonmatch")">
                                        @subj.GetDisplayName()
                                    </span>
                                }
                            </div>

                            <p class="text small mb-2 fw-semibold">Търси помощ по:</p>
                            <div class="match-subjects-scroll mb-2">
                                @foreach (var subj in student.student.NeedsHelpWith.Where(s => s != SubjectEnum.NotSpecified))
                                {
                                    var isMatch = selectedNeedsHelpWith.Contains(subj);
                                    <span class="badge rounded-pill px-3 py-1 me-2 @(isMatch ? "badge-match" : "badge-nonmatch")">
                                        @subj.GetDisplayName()
                                    </span>
                                }
                            </div>

                            @* Бутони *@
                            <div class="mt-auto d-flex gap-2">
                                @if (student.student.Grade == currentStudent?.Grade)
                                {
                                    @if (!isAlreadyRequested && !isAlreadySwapped)
                                    {
                                        <button class="btn btn-primary" disabled="@(!canRequestHelp || (swapRequestCount > 10 || swapActiveCount > 3) || (otherSwapRequestCount > 10 || otherSwapActiveCount > 3))" @onclick="() => OpenModal(student.student, true)"> Помоли за помощ</button>
                                        <button class="btn btn-primary" disabled="@(!canOfferHelp || (swapRequestCount > 10 || swapActiveCount > 3) || (otherSwapRequestCount > 10 || otherSwapActiveCount > 3))" @onclick="() => OpenModal(student.student, false)">Предложи помощ</button>
                                    }
                                    else if (isAlreadyRequested && !isAlreadySwapped)
                                    {
                                        <p>Очаква се приемане на заявката ти</p>
                                        <button class="btn btn-outline-secondary" @onclick="() => CancelSwapRequest(swap)">Отмени заявката ми</button>
                                    }
                                    else if (!isAlreadyRequested && isAlreadySwapped)
                                    {
                                        <button class="btn btn-primary" @onclick="() => GoToSwapDetails(swap)">Виж свапа</button>
                                    }
                                    <button class="btn btn-outline-secondary flex-fill" @onclick="() => ViewProfile(student.student)">Виж профила</button>
                                }
                                else
                                {
                                    <button class="btn btn-outline-secondary flex-fill w-100" @onclick="() => ViewProfile(student.student)">Виж профила</button>
                                }
                            </div>
                        </div>
                    </div>
                </div>



            }
        </div>

    }
}


<ModalRequestSwap IsOpen="@modalOpen"
              student="@modalTargetStudent"
              otherStudent="@currentStudent"
              isRequiringHelp="@modalIsHelping"
              OnClose="SendRequestForSwapAndCloseModal" />


@code {
    private Student? currentStudent;

    private HashSet<int> allGrades = new();
    private HashSet<SubjectEnum> allSubjects = new();
    private List<Student> allStudents = new();

    private HashSet<int> selectedGrades = new();
    private HashSet<SubjectEnum> selectedCanHelpWith = new();
    private HashSet<SubjectEnum> selectedNeedsHelpWith = new();

    private List<Student> filteredStudents = new();
    private List<(Student student, double compatibility, HashSet<SubjectEnum> commonCan, HashSet<SubjectEnum> commonNeeds)> filteredStudentsCompatib = new();

    private SubjectEnum selectedSubjectForSwap = SubjectEnum.NotSpecified;

    private bool modalOpen = false;
    private Student modalTargetStudent;
    private bool modalIsHelping;

    protected override void OnInitialized()
    {
        currentStudent = AppState.CurrentUser;

        if (currentStudent != null)
        {
            allStudents = StudentManager.GetAllStudents().Where(s => s.Id != currentStudent.Id).GroupBy(s => s.Id).Select(g => g.First()).ToList();


            allSubjects = Enum.GetValues(typeof(SubjectEnum)).Cast<SubjectEnum>().Where(s => s != SubjectEnum.NotSpecified).ToHashSet();
            allGrades = allStudents.Select(s => s.Grade).ToHashSet();

            AutoFilter();
            ApplyFilter();
        }
    }

    private void ApplyFilter()
    {
        filteredStudents = allStudents.Where(s =>
            ((selectedCanHelpWith.Count == 0 || s.CanHelpWith.Overlaps(selectedCanHelpWith)) ||
            (selectedNeedsHelpWith.Count == 0 || s.NeedsHelpWith.Overlaps(selectedNeedsHelpWith))) &&
            (selectedGrades.Count == 0 || selectedGrades.Contains(s.Grade))).ToList();

        filteredStudentsCompatib.Clear();
        foreach (var student in filteredStudents)
        {
            var compatibility = CalculateCompatibility(student, out HashSet<SubjectEnum> commonCan, out HashSet<SubjectEnum> commonNeeds);
            filteredStudentsCompatib.Add((student, compatibility, commonCan, commonNeeds));
        }
        filteredStudentsCompatib = filteredStudentsCompatib.OrderByDescending(s => s.compatibility).ToList();
    }

    private void AutoFilter()
    {
        selectedCanHelpWith = currentStudent.NeedsHelpWith.ToHashSet();
        selectedNeedsHelpWith = currentStudent.CanHelpWith.ToHashSet();
        selectedGrades.Clear();
        selectedGrades.Add(currentStudent.Grade);
        ApplyFilter();
    }

    private void ResetFilters()
    {
        selectedGrades.Clear();
        selectedCanHelpWith.Clear();
        selectedNeedsHelpWith.Clear();

        ApplyFilter();
    }

    private void ToggleGrade(int grade, bool isChecked)
    {
        if (isChecked) selectedGrades.Add(grade);
        else selectedGrades.Remove(grade);
        ApplyFilter();
    }

    private void ToggleSubject(SubjectEnum subject, bool isChecked, HashSet<SubjectEnum> targetList)
    {
        if (isChecked) targetList.Add(subject);
        else targetList.Remove(subject);
        ApplyFilter();
    }

    private void SelectAllGrades()
    {
        selectedGrades.Clear();
        foreach (int grade in allGrades)
            selectedGrades.Add(grade);

        ApplyFilter();
    }

    private void ClearAllGrades()
    {
        selectedGrades.Clear();
        ApplyFilter();
    }

    private void SelectAllSubjects(HashSet<SubjectEnum> targetList)
    {
        targetList.Clear();
        foreach (var subject in allSubjects)
            targetList.Add(subject);

        ApplyFilter();
    }

    private void ClearAllSubjects(HashSet<SubjectEnum> targetList)
    {
        targetList.Clear();
        ApplyFilter();
    }

    private double CalculateCompatibility(Student student, out HashSet<SubjectEnum> commonCan, out HashSet<SubjectEnum> commonNeeds)
    {
        commonCan = student.CanHelpWith?.Where(s => s != SubjectEnum.NotSpecified).Intersect(selectedCanHelpWith).ToHashSet();
        commonNeeds = student.NeedsHelpWith?.Where(s => s != SubjectEnum.NotSpecified).Intersect(selectedNeedsHelpWith).ToHashSet();

        if (selectedCanHelpWith.Count == 0 && selectedNeedsHelpWith.Count == 0)
            return 0;

        else if (selectedCanHelpWith.Count == 0 && selectedNeedsHelpWith.Count > 0)
            return ((double)commonNeeds.Count / selectedNeedsHelpWith.Count) * 100;

        else if (selectedCanHelpWith.Count > 0 && selectedNeedsHelpWith.Count == 0)
            return ((double)commonCan.Count / selectedCanHelpWith.Count) * 100;

        else
            return (((double)commonCan.Count / selectedCanHelpWith.Count) + ((double)commonNeeds.Count / selectedNeedsHelpWith.Count)) / 2 * 100;
    }

    private void RequestHelp(Student student1, Student student2, SubjectEnum subject)
    {
        SwapModel newSwap = SwapManager.RequestHelp(student1, student2, subject, currentStudent);
    }
    private void OfferHelp(Student student1, Student student2, SubjectEnum subject)
    {
        SwapModel newSwap = SwapManager.OfferHelp(student1, student2, subject, currentStudent);
    }
    private void CancelSwapRequest(SwapModel swap)
    {
        SwapManager.CancelMyRequest(swap);
    }

    private void ViewProfile(Student student)
    {
        Navigation.NavigateTo($"/other-profile/{student.Id}");
    }


    private void OpenModal(Student target, bool isHelping)
    {
        modalTargetStudent = target;
        modalIsHelping = isHelping;
        modalOpen = true;
    }
    private void SendRequestForSwapAndCloseModal(SubjectEnum? selectedSubject)
    {
        modalOpen = false;

        if (selectedSubject.HasValue && modalTargetStudent != null && currentStudent != null)
        {
            SwapModel? newSwap;
            if 
                (modalIsHelping) newSwap = SwapManager.OfferHelp(modalTargetStudent, currentStudent, selectedSubject.Value, currentStudent);
            else 
                newSwap = SwapManager.RequestHelp(currentStudent, modalTargetStudent, selectedSubject.Value, currentStudent);
        }

        modalTargetStudent = null;

        InvokeAsync(StateHasChanged);
    }

    private void GoToSwapDetails(SwapModel swap)
    {
        Navigation.NavigateTo($"/chat/{swap.Id}");
    }


    private static bool ValueToBool(object? value)
    {
        if (value is bool b) return b;
        var s = value?.ToString();
        if (string.IsNullOrEmpty(s)) return false;
        return s.Equals("true", StringComparison.OrdinalIgnoreCase)
            || s.Equals("on", StringComparison.OrdinalIgnoreCase)
            || s.Equals("1");
    }
}

<style>
    fieldset {
        border: none;
        padding: 0;
        margin-bottom: 1.2rem;
    }

    legend.filter-legend {
        font-size: 1.2rem;
        font-weight: 500;
        color: #333;
    }

    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem;
        align-items: flex-end;
        margin-bottom: 1rem;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 500;
            margin-bottom: 0.2rem;
        }

        .filter-group select,
        .filter-group input {
            font-size: 0.9rem;
            padding: 0.2rem 0.4rem;
        }

    .match-subjects-container {
        padding-bottom: 0.5rem;
    }

    .match-subjects-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .match-subjects-label {
        min-width: 110px;
        font-weight: 600;
        font-size: 0.9rem;
        color: #555;
        white-space: nowrap;
    }

    .match-subjects-scroll {
        overflow-x: auto;
        display: flex;
        gap: 0.5rem;
        scrollbar-width: thin;
    }

        .match-subjects-scroll::-webkit-scrollbar {
            height: 6px;
        }

        .match-subjects-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(0,0,0,0.15);
            border-radius: 3px;
        }

    /* Светлее синий */
    .light-blue-badge {
        background-color: #e6f0ff; /* Было #cce5ff — теперь ещё светлее */
        color: #003366;
        font-weight: 400;
    }

    .light-red-badge {
        background-color: #fce7e9;
        color: #842029;
        font-weight: 400;
    }

    .badge-match {
        background-color: #a8d0ff; /* более яркий светло-синий */
        color: #003366;
        font-weight: 600;
    }

    .badge-nonmatch {
        background-color: #e6f0ff; /* более бледный */
        color: #555;
        font-weight: 400;
    }

    fieldset {
        border: none;
        padding: 0;
        margin-bottom: 0.3rem;
    }

    .filter-row {
        display: flex;
        align-items: flex-start;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .filter-label {
        flex: 0 0 130px;
        font-weight: 600;
        font-size: 1rem;
        color: #333;
        user-select: none;
        padding-top: 0.25rem;
        white-space: nowrap; /* вот эта строка — запрет переноса */
    }


    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        flex: 1 1 auto;
    }

        .checkbox-group > div {
            flex: 0 0 auto;
            min-width: 45px;
        }

    .form-check-label {
        user-select: none;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .btn-link {
        font-size: 0.85rem;
        padding: 0 0.4rem;
        margin-right: 0.5rem;
    }

    .buttons-row {
        margin-bottom: 0.5rem;
    }
    /* Радиокнопки в линию */
    .match-mode {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

        .match-mode label {
            user-select: none;
            font-size: 0.9rem;
        }
</style>