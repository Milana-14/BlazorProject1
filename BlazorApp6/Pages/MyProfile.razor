@page "/my-profile" // страница за преглед и редактиране на собствения профил
@inject NavigationManager Navigation
@inject AppState AppState
@inject StudentManager StudentManager
@inject AvatarManager AvatarManager
@inject SubjectsManager SubjectsManager
@inject SwapManager SwapManager
@rendermode InteractiveServer

<h3>Мой профил</h3>

@if (student == null)
{
    <p>Моля, влезте в профила си</p>
}
else if (student is not null)
{
    @if (!isEditing)
    {
        <img src="@AvatarManager.GetAvatarUrl(student.AvatarName)" alt="Avatar" class="profile-avatar" />
        <p class="text-username">@student.FirstName @student.SecName</p>
        <p class="text-grade">Клас: @student.Grade</p>

        allSwaps = SwapManager.FindSwapsByStudentId(student.Id);
        averageRating = (student.HelpGivenCount == 0) ? 0 : student.HelpRatings.Sum() / student.HelpGivenCount;

        <div class="profile-container-stats">
            <p>Активни свапове: @allSwaps.Where(s => s.Status == SwapStatus.Confirmed || s.Status == SwapStatus.PendingCompleted || s.Status == SwapStatus.CompletedNotRated).Count()</p>
            <p>Общо свапове: @allSwaps.Count()</p>
            <p>Рейтинг: @Math.Round(averageRating, 1)</p>
            <p>Монети: @student.Coins</p>
        </div>

        <div class="profile-container-persinfo">
            <div>
                <p class="text-help-with">Мога да помогна по:</p>
                @foreach (var subj in student.CanHelpWith.Select(s => s.GetDisplayName()))
                {
                    <span class="badge-match">@subj</span>
                }
            </div>
            <div>
                <p class="text-help-with">Търся помощ по:</p>
                @foreach (var subj in student.NeedsHelpWith.Select(s => s.GetDisplayName()))
                {
                    <span class="badge-match">@subj</span>
                }
            </div>

            <p><strong>Имейл:</strong> @student.Email</p>

            <button class="btn btn-primary" @onclick="() => isEditing = true">Редактиране</button>
        </div>

        <button class="btn btn-secondary" @onclick="ExitProfile">Изход</button>
    }
    else
    {
        <EditForm Model="@student" OnValidSubmit="SaveChanges">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div>
                <label>Аватар:</label>
                <InputFile OnChange="(e) => SelectFile(e.File)" accept=".jpg,.jpeg,.png" />
                <button type="button" class="btn btn-danger" @onclick="() => AvatarManager.DeleteAvatar(student)">Изтрий аватара</button>
            </div>

            <div class="mb-3">
                <label>Име:</label>
                <InputText class="form-control" @bind-Value="student.FirstName" />
            </div>

            <div class="mb-3">
                <label>Фамилия:</label>
                <InputText class="form-control" @bind-Value="student.SecName" />
            </div>

            <div class="mb-3">
                <label>Клас:</label>
                <InputNumber class="form-control" @bind-Value="student.Grade" />
            </div>

            <div class="mb-3">
                <label>Имейл:</label>
                <InputText class="form-control" @bind-Value="student.Email" />
            </div>

            <div class="filter-row">
                <h5>Мога да помогна с:</h5>
                <div class="checkbox-group">
                    @foreach (var subject in allSubjects)
                    {
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   checked="@student.CanHelpWith.Contains(subject)"
                                   @onchange="e => ToggleCanHelpSubject(subject, e.Value is true)" />
                            @subject.GetDisplayName()
                        </div>
                    }
                </div>
            </div>

            <div class="filter-row">
                <h5>Нуждая се от помощ по:</h5>
                <div class="checkbox-group">
                    @foreach (var subject in allSubjects)
                    {
                        <div class="form-check">
                            <input class="form-check-input"
                                   type="checkbox"
                                   checked="@student.NeedsHelpWith.Contains(subject)"
                                   @onchange="e => ToggleNeedsHelpSubject(subject, e.Value is true)" />
                            @subject.GetDisplayName()
                        </div>
                    }
                </div>
            </div>
            <button type="button" class="btn btn-success" @onclick="GoToChangePassword">Промени паролата</button>

            <button type="button" class="btn btn-success" @onclick="CancelEdit">Отказ</button>
            <button type="submit" class="btn btn-success">Запазване на промените</button>
        </EditForm>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger mt-3">@errorMessage</div>
    }

    @if (successMessageShown)
    {
        <div class="alert alert-success mt-3">Промените са запазени!</div>
    }
}


@code {
    private Student? student;
    private List<SubjectEnum> allSubjects = new();
    private List<Swap> allSwaps = new();
    private double averageRating = 0.0;
    private bool successMessageShown = false;
    private string errorMessage = string.Empty;
    private bool isEditing = false;

    protected override void OnInitialized()
    {
        student = AppState.CurrentUser;

        isEditing = false;

        allSubjects = Enum.GetValues(typeof(SubjectEnum)).Cast<SubjectEnum>().Where(s => s != SubjectEnum.NotSpecified).ToList();
    }

    private async Task SelectFile(IBrowserFile file)
    {
        if (file != null)
        {
            await AvatarManager.UploadAvatar(file, student);
            StateHasChanged();
        }
    }

    private void ToggleCanHelpSubject(SubjectEnum subject, bool isChecked)
    {
        if (isChecked)
            student.CanHelpWith.Add(subject);
        else
            student.CanHelpWith.Remove(subject);
    }

    private void ToggleNeedsHelpSubject(SubjectEnum subject, bool isChecked)
    {
        if (isChecked)
            student.NeedsHelpWith.Add(subject);
        else
            student.NeedsHelpWith.Remove(subject);

    }


    private void GoToChangePassword()
    {
        Navigation.NavigateTo("/change-password");
    }

    private void SaveChanges()
    {
        if (student is not null)
        {
            try
            {
                StudentManager.UpdateStudent(student);
                SubjectsManager.UpdateStudentSubjects(student);
                isEditing = false;
                successMessageShown = true;
            }
            catch (Exception ex)
            {
                errorMessage = ex.ToString();
            }
        }
    }
    private void CancelEdit()
    {
        student = AppState.CurrentUser;
        isEditing = false;
        successMessageShown = false;
    }

    private void ExitProfile()
    {
        AppState.CurrentUser = null;
        Navigation.NavigateTo("/login");
    }
}

<style>
    

    .checkbox-group {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        flex: 1 1 auto;
    }

        .checkbox-group > div {
            flex: 0 0 auto;
            min-width: 45px;
        }

    .form-check-label {
        user-select: none;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .avatar-xl {
        width: 160px;
        height: 160px;
        object-fit: cover;
        border-radius: 50%;
        display: block;
    }
</style>