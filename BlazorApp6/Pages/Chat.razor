@page "/chat/{SwapId:guid}" // страница за чат
@implements IAsyncDisposable
@inject NavigationManager NavigationManager
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Forms
@inject IHttpContextAccessor HttpContextAccessor
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject StudentManager StudentManager
@inject AvatarManager AvatarManager
@inject SwapManager SwapManager
@inject ChatManager ChatManager
@rendermode InteractiveServer
@using Microsoft.AspNetCore.SignalR.Client
@using SwapModel = BlazorApp6.Models.Swap


<div class="main-page">
@if (!string.IsNullOrEmpty(errorMessage))
{
    <p class="text-danger">@errorMessage</p>
}
else
{
    <div class="chat-page">

        <div class="sidebar p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5>@otherStudent.FirstName @otherStudent.SecName</h5>
                <button class="btn btn-sm btn-danger" @onclick="ReportPartner">Репортни</button>
            </div>
            <p><strong>Предмет:</strong> @swap.SubjectForHelp</p>
            <p><strong>Статус на свапа:</strong> @swap.Status</p>

            @if (swap.Status == SwapStatus.PendingCompleted)
            {
                if (swap.CompletionProposedByStudentId.HasValue && swap.CompletionProposedByStudentId.Value != currentStudent.Id)
                {
                    <div class="alert alert-warning p-2">
                        <p>@otherStudent.FirstName иска да завърши свапа</p>
                        <button class="btn btn-sm btn-success ms-2" @onclick="AcceptCompletion">Завърши</button>
                        <button class="btn btn-sm btn-secondary ms-1" @onclick="RejectCompletion">Продължи свапа</button>
                    </div>
                }
                else
                {
                    <div class="alert alert-info p-2">
                        <p>Вие предложихте да завършите свапа. Очаква се потвърждението на @otherStudent.FirstName.</p>
                    </div>
                }
            }
            else if (swap.Status == SwapStatus.CompletedNotRated)
            {
                if (isStudentToRate)
                {
                    <p>Очаква се @otherStudent.FirstName да оцени Вашата помощ.</p>
                }
                else
                {
                    <p>Моля, оставете отзив за помощта на @otherStudent.FirstName @otherStudent.SecName.</p>
                }
            }
            else
            {
                <button class="btn btn-sm btn-primary" @onclick="ProposeCompletion">Предложи завършване</button>
            }
        </div>


        @if (swap.Status == SwapStatus.Confirmed || swap.Status == SwapStatus.PendingCompleted)
        {
    <div class="chat-container d-flex flex-column flex-grow-1">
        <div class="chat-window flex-grow-1 overflow-auto">
            @code { DateTime? lastDate = null; }
            @foreach (var m in messagesForChat)
                        {
                        DateTime date = m.Timestamp.Date;
                        if (lastDate == null || lastDate.Value != date)
                        {
            <div class="chat-date-separator">
                @date.ToString("dd MMMM yyyy")
            </div>
                        lastDate = date;
                        }

            @if (m.SenderName == $"{currentStudent.FirstName} {currentStudent.SecName}")
            {
                <div class="my-message">
                    @((MarkupString)m.Content)
                    <sub><small><time>@m.Timestamp.ToString("HH:mm")</time></small></sub>
                </div>
            }
            else if (m.SenderName == $"{otherStudent.FirstName} {otherStudent.SecName}")
            {
                <div class="other-message-sender">
                    <img src="@AvatarManager.GetAvatarUrl(otherStudent.AvatarName)" class="chat-avatar" />
                <div class="other-message">
                    @((MarkupString)m.Content)
                    <sub><small><time>@m.Timestamp.ToString("HH:mm")</time></small></sub>
                </div>
                </div>
            }
            else
            {
                <div class="system-message">
                    <i>@m.Content</i>
                    <small><time>@m.Timestamp.ToString("HH:mm")</time></small>
                </div>
            }
            }

            <div class="input-bar d-flex align-items-center gap-2 mt-2">
                <button class="btn btn-light rounded-circle" @onclick="ToggleEmojiPanel">😀</button>
                <InputFile OnChange="OnInputFileSelected" class="form-control-file" />
                <InputText @bind-Value="newMessage" placeholder="Напиши съобщение..." class="form-control flex-grow-1 type-message" />
                <button class="btn-primary-send-message" disabled="@string.IsNullOrWhiteSpace(newMessage)" @onclick="SendMessage">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>
    </div>
        }
        else if (swap.Status == SwapStatus.CompletedNotRated)
    {
        if (isStudentToRate)
        {
            <p>Очаква се @otherStudent.FirstName да оцени Вашата помощ.</p>
        }
        else
        {
            <div class="stars-container mb-3">
                @for (int i = 1; i <= 5; i++)
                {
                    <span class="star @(SelectedRating >= i ? "selected" : "")" @onclick="() => ChooseRating(i)">&#9733;</span>
                }
            </div>


            <div class="modal-actions mt-3 d-flex gap-2">
                <button class="btn btn-primary" disabled="@(!isChosen)" @onclick="RateStudentsHelp">Изпрати</button>
            </div>
        }
    }
    else if (swap.Status == SwapStatus.Completed)
    {
        <p>Този свап е завършен.</p>
    }
</div>
}
</div>

@code {
    [Parameter] public Guid swapId { get; set; }
    private SwapModel? swap;
    private Student? currentStudent;
    private Student? otherStudent;
    private HubConnection? hubConnection;

    private List<Message> messages = new();
    private List<MessageForChat> messagesForChat = new();
    private string newMessage = string.Empty;

    private bool isStudentToRate;
    private string? errorMessage;

    private int? SelectedRating { get; set; }
    private bool isChosen => SelectedRating != null;

    private ElementReference chatWindowRef;

    protected override async Task OnParametersSetAsync()
    {
        swap = SwapManager.FindSwapById(swapId);
        if (swap == null) { errorMessage = "Свапът не е намерен."; return; }

        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        if (!user.Identity.IsAuthenticated)
        {
            currentStudent = null;
            return;
        }

        var username = user.Identity.Name;

        currentStudent = StudentManager.FindStudent(s => s.Username == username);

        if (currentStudent == null)
        {
            errorMessage = "Профилът не е намерен.";
            return;
        }
        if (currentStudent == null) { errorMessage = "Моля, влезте в профила си."; return; }

        otherStudent = swap.Student1Id == currentStudent.Id
            ? StudentManager.FindStudent(s => s.Id == swap.Student2Id)
            : StudentManager.FindStudent(s => s.Id == swap.Student1Id);
        if (otherStudent == null) { errorMessage = "Другият ученик не е намерен."; return; }

        messages = ChatManager.GetMessagesFromDb(swapId);
        messagesForChat = messages.Select(m => new MessageForChat(
            m.SenderId == currentStudent.Id
                ? $"{currentStudent.FirstName} {currentStudent.SecName}"
                : $"{otherStudent.FirstName} {otherStudent.SecName}",
            m.Content,
            m.Timestamp)).ToList();

        if (hubConnection != null) return;

        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/chathub"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<string>("UserJoined", (username) =>
        {
            messagesForChat.Add(new MessageForChat(string.Empty, $"{username} влезе в чата", DateTime.Now));
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<Guid, string, string>("ReceiveMessage", (studentId, username, message) =>
        {
            messagesForChat.Add(new MessageForChat(username, message, DateTime.Now));
            InvokeAsync(StateHasChanged);
        });

        try
        {
            await hubConnection.StartAsync();
            await hubConnection.SendAsync("JoinChat",
                new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)));
        }
        catch (Exception ex)
        {
            errorMessage = "Не успяхме да се свържем с чата: " + ex.Message;
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage) || hubConnection == null) return;

        await hubConnection.SendAsync("SendMessage",
            new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)),
            newMessage);

        newMessage = string.Empty;
    }

    private void ToggleEmojiPanel() { /* вставка эмодзи */ }

    private async Task OnInputFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null) return;

        using var stream = file.OpenReadStream(10 * 1024 * 1024);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        byte[] fileBytes = ms.ToArray();

        await hubConnection.SendAsync("SendFile",
    new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)),
    file.Name,
    fileBytes);

    }

    private void ProposeCompletion() => SwapManager.ProposeCompletingSwap(swap, currentStudent.Id);
    private void AcceptCompletion()
    {
        swap.Status = SwapStatus.CompletedNotRated;
        SwapManager.UpdateSwapInDb(swap);
        isStudentToRate = currentStudent.Id == swap.Student2Id;
    }
    private void RejectCompletion() => SwapManager.RejectCompletion(swap);

    private void ChooseRating(int rating) => SelectedRating = rating;

    private async Task RateStudentsHelp()
    {
        if (SelectedRating == null) return;

        otherStudent.HelpGivenCount++;
        otherStudent.HelpRatings.Add(SelectedRating.Value);
        otherStudent.Coins++;
        StudentManager.UpdateStudent(otherStudent);

        currentStudent.Coins--;
        StudentManager.UpdateStudent(currentStudent);

        SwapManager.CompleteSwap(swap);

        NavigationManager.NavigateTo("/my-swaps");
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null && currentStudent != null)
        {
            await hubConnection.SendAsync("LeaveChat",
                new UserConnection(swapId, new StudentToConnect(currentStudent.Id, currentStudent.FirstName, currentStudent.SecName)));
            await hubConnection.DisposeAsync();
        }
    }

    private async Task ReportPartner() { /* TODO */ }
}
