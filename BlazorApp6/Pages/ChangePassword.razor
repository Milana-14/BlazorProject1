@page "/change-password"
@using Microsoft.AspNetCore.Authentication
@using Microsoft.AspNetCore.Components.Forms
@inject IHttpContextAccessor HttpContextAccessor
@inject Microsoft.AspNetCore.Components.Authorization.AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject StudentManager StudentManager
@rendermode InteractiveServer

<div class="login-page">
    <div class="login-card">

        <h3>Смяна на паролата</h3>

        @if (student == null)
        {
            <p>Моля, влезте в профила си</p>
        }
        else
        {
            <EditForm Model="student" OnValidSubmit="ChangeThePassword">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="login-form">
                    <input type="password"
                           placeholder="Текуща парола"
                           @bind="currentPassword" />
                </div>

                <div class="login-form">
                    <input type="password"
                           placeholder="Нова парола"
                           @bind="newPassword" />
                </div>

                <div class="login-form">
                    <input type="password"
                           placeholder="Потвърди новата парола"
                           @bind="confirmPassword" />
                </div>

                <button type="submit" class="btn-login">
                    Запази
                </button>
            </EditForm>

            @if (!string.IsNullOrEmpty(message))
            {
                <div class="alert @(isSuccess ? "alert-success" : "alert-danger") mt-3">
                    @message
                </div>
            }
        }

    </div>
</div>

@code {
    private Student? student;
    private string currentPassword;
    private string newPassword;
    private string confirmPassword;
    private string message;
    private bool isSuccess = false;
    private bool isUpdated = false;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = state.User;

        if (!user.Identity.IsAuthenticated)
        {
            student = null;
            return;
        }

        var username = user.Identity.Name;

        student = StudentManager.FindStudent(s => s.Username == username);

        if (student == null)
        {
            return;
        }
    }

    private void ChangeThePassword()
    {
        if (student == null)
        {
            message = "Няма активен потребител.";
            isSuccess = false;
            return;
        }

        if (HashPasswordService.ComparePasswords(student.Password, newPassword))
        {
            message = "Грешна текуща парола.";
            isSuccess = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(newPassword) || newPassword.Length < 6)
        {
            message = "Новата парола трябва да бъде поне 6 символа.";
            isSuccess = false;
            return;
        }

        if (newPassword != confirmPassword)
        {
            message = "Новата парола не съвпада с потвърждението.";
            isSuccess = false;
            return;
        }

        student.ChangePassword(HashPasswordService.HashPassword(newPassword));
        isUpdated = StudentManager.UpdateStudent(student);

        if (!isUpdated)
        {
            message = "Ученикът не е намерен.";
            isSuccess = false;
            return;
        }

        message = "Паролата е сменена успешно.";
        isSuccess = true;
        Navigation.NavigateTo("/my-profile");
    }
}
